package models

import (
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
)

// VulnerabilitySeverity 漏洞严重性级别
type VulnerabilitySeverity string

const (
	SeverityCritical VulnerabilitySeverity = "critical" // 严重
	SeverityHigh     VulnerabilitySeverity = "high"     // 高危
	SeverityMedium   VulnerabilitySeverity = "medium"   // 中危
	SeverityLow      VulnerabilitySeverity = "low"      // 低危
	SeverityInfo     VulnerabilitySeverity = "info"     // 信息
)

// VulnerabilityStatus 漏洞状态
type VulnerabilityStatus string

const (
	StatusUnverified    VulnerabilityStatus = "unverified"     // 未验证
	StatusVerified      VulnerabilityStatus = "verified"       // 已验证
	StatusFixed         VulnerabilityStatus = "fixed"          // 已修复
	StatusFalsePositive VulnerabilityStatus = "false_positive" // 误报
	StatusIgnored       VulnerabilityStatus = "ignored"        // 已忽略
)

// VulnerabilityType 漏洞类型
type VulnerabilityType string

const (
	TypeWebVuln       VulnerabilityType = "web"       // Web漏洞
	TypeSystemVuln    VulnerabilityType = "system"    // 系统漏洞
	TypeNetworkVuln   VulnerabilityType = "network"   // 网络漏洞
	TypeConfigVuln    VulnerabilityType = "config"    // 配置漏洞
	TypeComponentVuln VulnerabilityType = "component" // 组件漏洞
)

// Vulnerability 漏洞模型
type Vulnerability struct {
	ID            primitive.ObjectID     `bson:"_id,omitempty" json:"id"`
	ProjectID     primitive.ObjectID     `bson:"projectId" json:"projectId"`
	TaskID        primitive.ObjectID     `bson:"taskId" json:"taskId"`
	AssetID       primitive.ObjectID     `bson:"assetId" json:"assetId"`
	Title         string                 `bson:"title" json:"title"`
	Description   string                 `bson:"description" json:"description"`
	Solution      string                 `bson:"solution" json:"solution"`
	References    []string               `bson:"references" json:"references"`
	CVEID         string                 `bson:"cveId" json:"cveId"`
	CWEID         string                 `bson:"cweId" json:"cweId"`
	Severity      VulnerabilitySeverity  `bson:"severity" json:"severity"`
	Status        VulnerabilityStatus    `bson:"status" json:"status"`
	Type          VulnerabilityType      `bson:"type" json:"type"`
	AffectedURL   string                 `bson:"affectedUrl" json:"affectedUrl"`
	AffectedHost  string                 `bson:"affectedHost" json:"affectedHost"`
	AffectedPort  int                    `bson:"affectedPort" json:"affectedPort"`
	AffectedParam string                 `bson:"affectedParam" json:"affectedParam"`
	Payload       string                 `bson:"payload" json:"payload"`
	Request       string                 `bson:"request" json:"request"`
	Response      string                 `bson:"response" json:"response"`
	Screenshot    string                 `bson:"screenshot" json:"screenshot"`
	POCName       string                 `bson:"pocName" json:"pocName"`
	DiscoveredAt  time.Time              `bson:"discoveredAt" json:"discoveredAt"`
	VerifiedAt    time.Time              `bson:"verifiedAt" json:"verifiedAt"`
	FixedAt       time.Time              `bson:"fixedAt" json:"fixedAt"`
	CreatedAt     time.Time              `bson:"createdAt" json:"createdAt"`
	UpdatedAt     time.Time              `bson:"updatedAt" json:"updatedAt"`
	CreatedBy     string                 `bson:"createdBy" json:"createdBy"`
	UpdatedBy     string                 `bson:"updatedBy" json:"updatedBy"`
	Tags          []string               `bson:"tags" json:"tags"`
	CustomFields  map[string]interface{} `bson:"customFields" json:"customFields"`
	Score         float64                `bson:"score" json:"score"`
	ReproSteps    string                 `bson:"reproSteps" json:"reproSteps"`
	Notes         string                 `bson:"notes" json:"notes"`
}

// VulnScanTask 漏洞扫描任务
type VulnScanTask struct {
	ID            primitive.ObjectID `bson:"_id,omitempty" json:"id"`
	ProjectID     primitive.ObjectID `bson:"projectId" json:"projectId"`
	TaskName      string             `bson:"taskName" json:"taskName"`
	Targets       []string           `bson:"targets" json:"targets"`
	TargetType    string             `bson:"targetType" json:"targetType"` // url, host, asset, domain
	Status        string             `bson:"status" json:"status"`         // pending, running, completed, failed
	CreatedAt     time.Time          `bson:"createdAt" json:"createdAt"`
	StartedAt     time.Time          `bson:"startedAt" json:"startedAt"`
	CompletedAt   time.Time          `bson:"completedAt" json:"completedAt"`
	Progress      float64            `bson:"progress" json:"progress"` // 0-100
	Config        VulnScanConfig     `bson:"config" json:"config"`
	ResultSummary VulnScanSummary    `bson:"resultSummary" json:"resultSummary"`
	Error         string             `bson:"error" json:"error"`
	NodeID        string             `bson:"nodeId" json:"nodeId"` // 执行任务的节点ID
	Tags          []string           `bson:"tags" json:"tags"`
}

// VulnScanConfig 漏洞扫描配置
type VulnScanConfig struct {
	POCIDs          []string              `bson:"pocIds" json:"pocIds"`                   // POC ID列表
	POCCategories   []string              `bson:"pocCategories" json:"pocCategories"`     // POC分类
	Concurrency     int                   `bson:"concurrency" json:"concurrency"`         // 并发数
	Timeout         int                   `bson:"timeout" json:"timeout"`                 // 超时时间(秒)
	RetryCount      int                   `bson:"retryCount" json:"retryCount"`           // 重试次数
	RateLimit       int                   `bson:"rateLimit" json:"rateLimit"`             // 请求速率限制(每秒)
	FollowRedirect  bool                  `bson:"followRedirect" json:"followRedirect"`   // 是否跟随重定向
	CustomHeaders   map[string]string     `bson:"customHeaders" json:"customHeaders"`     // 自定义请求头
	Cookies         string                `bson:"cookies" json:"cookies"`                 // Cookie
	Proxy           string                `bson:"proxy" json:"proxy"`                     // 代理
	ScanDepth       int                   `bson:"scanDepth" json:"scanDepth"`             // 扫描深度
	SaveToDB        bool                  `bson:"saveToDB" json:"saveToDB"`               // 是否保存到数据库
	VerifyVuln      bool                  `bson:"verifyVuln" json:"verifyVuln"`           // 是否验证漏洞
	MinimumSeverity VulnerabilitySeverity `bson:"minimumSeverity" json:"minimumSeverity"` // 最低严重性级别
}

// VulnScanSummary 漏洞扫描结果摘要
type VulnScanSummary struct {
	TotalTargets   int            `bson:"totalTargets" json:"totalTargets"`     // 扫描目标总数
	ScannedTargets int            `bson:"scannedTargets" json:"scannedTargets"` // 已扫描目标数
	TotalVulns     int            `bson:"totalVulns" json:"totalVulns"`         // 漏洞总数
	CriticalVulns  int            `bson:"criticalVulns" json:"criticalVulns"`   // 严重漏洞数
	HighVulns      int            `bson:"highVulns" json:"highVulns"`           // 高危漏洞数
	MediumVulns    int            `bson:"mediumVulns" json:"mediumVulns"`       // 中危漏洞数
	LowVulns       int            `bson:"lowVulns" json:"lowVulns"`             // 低危漏洞数
	InfoVulns      int            `bson:"infoVulns" json:"infoVulns"`           // 信息漏洞数
	VulnTypes      map[string]int `bson:"vulnTypes" json:"vulnTypes"`           // 漏洞类型统计
}

// POC 漏洞验证脚本
type POC struct {
	ID             primitive.ObjectID    `bson:"_id,omitempty" json:"id"`
	Name           string                `bson:"name" json:"name"`
	Description    string                `bson:"description" json:"description"`
	Author         string                `bson:"author" json:"author"`
	References     []string              `bson:"references" json:"references"`
	CVEID          string                `bson:"cveId" json:"cveId"`
	CWEID          string                `bson:"cweId" json:"cweId"`
	Severity       VulnerabilitySeverity `bson:"severity" json:"severity"`
	Type           VulnerabilityType     `bson:"type" json:"type"`
	Category       string                `bson:"category" json:"category"`
	Script         string                `bson:"script" json:"script"`         // POC脚本内容
	ScriptType     string                `bson:"scriptType" json:"scriptType"` // 脚本类型: go, python, yaml, etc.
	CreatedAt      time.Time             `bson:"createdAt" json:"createdAt"`
	UpdatedAt      time.Time             `bson:"updatedAt" json:"updatedAt"`
	Tags           []string              `bson:"tags" json:"tags"`
	Enabled        bool                  `bson:"enabled" json:"enabled"`
	RequiredParams []string              `bson:"requiredParams" json:"requiredParams"`
	DefaultParams  map[string]string     `bson:"defaultParams" json:"defaultParams"`
	SuccessRate    float64               `bson:"successRate" json:"successRate"`   // 成功率统计
	RunCount       int                   `bson:"runCount" json:"runCount"`         // 运行次数
	SuccessCount   int                   `bson:"successCount" json:"successCount"` // 成功次数
	FailCount      int                   `bson:"failCount" json:"failCount"`       // 失败次数
}

// POCResult POC执行结果
type POCResult struct {
	ID            primitive.ObjectID `bson:"_id,omitempty" json:"id"`
	TaskID        primitive.ObjectID `bson:"taskId" json:"taskId"`
	POCID         primitive.ObjectID `bson:"pocId" json:"pocId"`
	Target        string             `bson:"target" json:"target"`
	Success       bool               `bson:"success" json:"success"`
	Output        string             `bson:"output" json:"output"`
	Error         string             `bson:"error" json:"error"`
	ExecutionTime int64              `bson:"executionTime" json:"executionTime"` // 执行时间(毫秒)
	CreatedAt     time.Time          `bson:"createdAt" json:"createdAt"`
	VulnID        primitive.ObjectID `bson:"vulnId" json:"vulnId"`
	Request       string             `bson:"request" json:"request"`
	Response      string             `bson:"response" json:"response"`
	Payload       string             `bson:"payload" json:"payload"`
	Screenshot    string             `bson:"screenshot" json:"screenshot"`
	Params        map[string]string  `bson:"params" json:"params"`
}
