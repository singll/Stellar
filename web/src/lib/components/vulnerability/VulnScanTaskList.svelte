<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		scanTaskList,
		scanTaskPagination,
		scanTaskFilters
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { TASK_STATUS_CONFIG, SEVERITY_CONFIG } from '$lib/types/vulnerability';
	import type { VulnScanTask, VulnScanConfig } from '$lib/types/vulnerability';

	// 外部回调属性
	let {
		onCreateTask = () => {},
		onEditTask = () => {},
		onEdit = () => {}, // 添加 onEdit 回调
		onDelete = () => {}, // 添加 onDelete 回调
		onStart = () => {}, // 添加 onStart 回调
		onStop = () => {}, // 添加 onStop 回调
		onViewResults = () => {}
	} = $props();

	// 组件状态
	let isLoading = $state(false);
	let showDeleteDialog = $state(false);
	let currentTask = $state<VulnScanTask | null>(null);

	// 列表状态
	let tasks = $state<VulnScanTask[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		projectId: undefined as string | undefined,
		status: undefined as string | undefined
	});

	// 订阅 store 变化
	$effect(() => {
		const unsubscribeTasks = scanTaskList.subscribe((value) => (tasks = value));
		const unsubscribePagination = scanTaskPagination.subscribe((value) => (pagination = value));
		const unsubscribeFilters = scanTaskFilters.subscribe((value) => (filters = value));

		return () => {
			unsubscribeTasks();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// 页面加载时获取数据
	onMount(() => {
		loadTasks();
	});

	// 加载任务列表
	async function loadTasks() {
		isLoading = true;
		try {
			await vulnStore.loadScanTasks({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '加载扫描任务列表失败: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// 分页处理
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadTasks();
	}

	// 过滤处理
	function handleFilterChange() {
		pagination.page = 1;
		loadTasks();
	}

	// 删除任务
	function deleteTask(task: VulnScanTask) {
		currentTask = task;
		showDeleteDialog = true;
	}

	// 确认删除任务
	async function confirmDelete() {
		if (!currentTask) return;

		// 这里应该调用删除API
		// const success = await vulnStore.deleteScanTask(currentTask.id);
		// if (success) {
		showDeleteDialog = false;
		currentTask = null;
		loadTasks();
		// }
	}

	// 启动任务
	async function startTask(task: VulnScanTask) {
		const success = await vulnStore.startScanTask(task.id);
		if (success) {
			loadTasks();
		}
	}

	// 停止任务
	async function stopTask(task: VulnScanTask) {
		const success = await vulnStore.stopScanTask(task.id);
		if (success) {
			loadTasks();
		}
	}

	// 获取状态样式
	function getStatusClass(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? `${config.bgColor} ${config.textColor}` : 'bg-gray-100 text-gray-800';
	}

	// 获取状态标签
	function getStatusLabel(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? config.label : status;
	}

	// 格式化日期
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN', {
			year: 'numeric',
			month: '2-digit',
			day: '2-digit',
			hour: '2-digit',
			minute: '2-digit'
		});
	}

	// 格式化持续时间
	function formatDuration(startTime: string, endTime?: string) {
		const start = new Date(startTime);
		const end = endTime ? new Date(endTime) : new Date();
		const diff = end.getTime() - start.getTime();

		const hours = Math.floor(diff / (1000 * 60 * 60));
		const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
		const seconds = Math.floor((diff % (1000 * 60)) / 1000);

		if (hours > 0) {
			return `${hours}h ${minutes}m`;
		} else if (minutes > 0) {
			return `${minutes}m ${seconds}s`;
		} else {
			return `${seconds}s`;
		}
	}

	// 计算进度百分比
	function getProgressPercentage(task: VulnScanTask): number {
		return Math.round(task.progress || 0);
	}

	// 获取漏洞严重性统计的显示
	function getSeverityStats(summary: any) {
		if (!summary) return '';

		const stats = [];
		if (summary.criticalVulns > 0) stats.push(`严重:${summary.criticalVulns}`);
		if (summary.highVulns > 0) stats.push(`高危:${summary.highVulns}`);
		if (summary.mediumVulns > 0) stats.push(`中危:${summary.mediumVulns}`);
		if (summary.lowVulns > 0) stats.push(`低危:${summary.lowVulns}`);
		if (summary.infoVulns > 0) stats.push(`信息:${summary.infoVulns}`);

		return stats.join(', ') || '无漏洞';
	}
</script>

<div class="container mx-auto p-6">
	<!-- 页面标题和操作栏 -->
	<div class="flex justify-between items-center mb-6">
		<div>
			<h1 class="text-3xl font-bold text-gray-900">漏洞扫描任务</h1>
			<p class="text-gray-600 mt-1">管理和监控漏洞扫描任务</p>
		</div>
		<div class="flex gap-3">
			<Button onclick={() => loadTasks()} variant="outline" disabled={isLoading}>
				{isLoading ? '刷新中...' : '刷新'}
			</Button>
			<Button onclick={() => onCreateTask()}>创建扫描任务</Button>
		</div>
	</div>

	<!-- 过滤栏 -->
	<Card class="mb-6">
		<CardContent class="p-4">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<!-- 项目过滤 -->
				<div>
					<label for="project-filter" class="block text-sm font-medium text-gray-700 mb-1">项目</label>
					<select
						id="project-filter"
						bind:value={filters.projectId}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>全部项目</option>
						<!-- 这里应该动态加载项目列表 -->
					</select>
				</div>

				<!-- 状态过滤 -->
				<div>
					<label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
					<select
						id="status-filter"
						bind:value={filters.status}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>全部状态</option>
						<option value="pending">等待中</option>
						<option value="queued">已入队</option>
						<option value="running">运行中</option>
						<option value="completed">已完成</option>
						<option value="failed">失败</option>
						<option value="canceled">已取消</option>
					</select>
				</div>

				<!-- 统计信息 -->
				<div class="flex items-end">
					<div class="text-sm text-gray-600">
						共 {pagination.total} 个任务
					</div>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- 任务列表 -->
	<div class="space-y-4">
		{#each tasks as task (task.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardContent class="p-6">
					<div class="flex justify-between items-start">
						<div class="flex-1">
							<div class="flex items-center gap-3 mb-2">
								<h3 class="text-lg font-semibold text-gray-900">{task.taskName}</h3>
								<Badge class={getStatusClass(task.status)}>
									{getStatusLabel(task.status)}
								</Badge>

								<!-- 进度条 -->
								{#if task.status === 'running'}
									<div class="flex items-center gap-2 ml-auto">
										<span class="text-sm text-gray-600">{getProgressPercentage(task)}%</span>
										<div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
											<div
												class="h-full bg-blue-500 transition-all duration-300"
												style="width: {getProgressPercentage(task)}%"
											></div>
										</div>
									</div>
								{/if}
							</div>

							<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
								<!-- 基本信息 -->
								<div>
									<div class="text-sm text-gray-500 mb-1">目标信息</div>
									<div class="text-sm">
										<div>目标数量: {task.targets.length}</div>
										<div>目标类型: {task.targetType}</div>
										<div class="truncate" title={task.targets.join(', ')}>
											目标: {task.targets.slice(0, 2).join(', ')}
											{#if task.targets.length > 2}
												<span class="text-gray-500">等{task.targets.length}个</span>
											{/if}
										</div>
									</div>
								</div>

								<!-- 扫描配置 -->
								<div>
									<div class="text-sm text-gray-500 mb-1">扫描配置</div>
									<div class="text-sm">
										<div>POC数量: {task.config.pocIds?.length || 0}</div>
										<div>并发数: {task.config.concurrency || 10}</div>
										<div>超时: {task.config.timeout || 30}s</div>
									</div>
								</div>

								<!-- 扫描结果 -->
								<div>
									<div class="text-sm text-gray-500 mb-1">扫描结果</div>
									<div class="text-sm">
										<div>总漏洞: {task.resultSummary?.totalVulns || 0}</div>
										<div>
											扫描进度: {task.resultSummary?.scannedTargets || 0}/{task.resultSummary
												?.totalTargets || 0}
										</div>
										<div class="truncate" title={getSeverityStats(task.resultSummary)}>
											{getSeverityStats(task.resultSummary)}
										</div>
									</div>
								</div>
							</div>

							<!-- 时间信息 -->
							<div class="text-xs text-gray-500 mb-3">
								创建时间: {formatDate(task.createdAt)}
								{#if task.startedAt}
									<span class="mx-2">|</span>
									开始时间: {formatDate(task.startedAt)}
								{/if}
								{#if task.completedAt}
									<span class="mx-2">|</span>
									完成时间: {formatDate(task.completedAt)}
									<span class="mx-2">|</span>
									耗时: {task.startedAt && task.completedAt ? formatDuration(task.startedAt, task.completedAt) : '-'}
								{:else if task.startedAt}
									<span class="mx-2">|</span>
									已运行: {formatDuration(task.startedAt)}
								{/if}
							</div>

							<!-- 错误信息 -->
							{#if task.error}
								<div
									class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded text-sm mb-3"
								>
									错误: {task.error}
								</div>
							{/if}

							<!-- 标签 -->
							{#if task.tags && task.tags.length > 0}
								<div class="flex flex-wrap gap-1 mb-3">
									{#each task.tags as tag}
										<Badge variant="outline" class="text-xs">{tag}</Badge>
									{/each}
								</div>
							{/if}
						</div>

						<!-- 操作按钮 -->
						<div class="flex flex-col gap-2 ml-4">
							<!-- 查看结果 -->
							{#if task.status === 'completed' && task.resultSummary?.totalVulns > 0}
								<Button size="sm" onclick={() => onViewResults(task)}>查看结果</Button>
							{/if}

							<!-- 启动/停止 -->
							{#if task.status === 'pending' || task.status === 'failed'}
								<Button size="sm" variant="outline" onclick={() => startTask(task)}>启动</Button>
							{:else if task.status === 'running'}
								<Button size="sm" variant="outline" onclick={() => stopTask(task)}>停止</Button>
							{/if}

							<!-- 编辑 -->
							{#if task.status === 'pending' || task.status === 'failed' || task.status === 'completed'}
								<Button size="sm" variant="outline" onclick={() => onEditTask(task)}>编辑</Button>
							{/if}

							<!-- 删除 -->
							<Button size="sm" variant="destructive" onclick={() => deleteTask(task)}>删除</Button>
						</div>
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- 空状态 -->
	{#if !isLoading && tasks.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">🔍</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">暂无扫描任务</h3>
			<p class="text-gray-500 mb-4">还没有创建任何漏洞扫描任务</p>
			<Button onclick={() => onCreateTask()}>创建第一个扫描任务</Button>
		</div>
	{/if}

	<!-- 分页 -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center mt-8">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					上一页
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					第 {pagination.page} 页，共 {pagination.totalPages} 页
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					下一页
				</Button>
			</div>
		</div>
	{/if}

	<!-- 加载状态 -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">加载中...</p>
			</div>
		</div>
	{/if}
</div>

<!-- 删除确认对话框 -->
{#if showDeleteDialog && currentTask}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
			<h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
			<p class="text-gray-600 mb-4">
				确定要删除扫描任务 "{currentTask.taskName}" 吗？此操作不可恢复。
			</p>
			<div class="flex justify-end gap-3">
				<Button variant="outline" onclick={() => (showDeleteDialog = false)}>取消</Button>
				<Button variant="destructive" onclick={confirmDelete}>确认删除</Button>
			</div>
		</div>
	</div>
{/if}
