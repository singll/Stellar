<script lang="ts">
	import { onMount, onDestroy } from 'svelte';
	import { get } from 'svelte/store';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import { vulnStore, scanTasks } from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { TASK_STATUS_CONFIG } from '$lib/types/vulnerability';
	import type { VulnScanTask } from '$lib/types/vulnerability';

	interface SeverityDistributionItem {
		label: string;
		count: number;
		percentage: number;
		color: string;
	}

	// å¤–éƒ¨å±æ€§
	let { refreshInterval = 5000, showAll = false } = $props(); // é»˜è®¤5ç§’åˆ·æ–°ä¸€æ¬¡

	// ç»„ä»¶çŠ¶æ€
	let isLoading = $state(false);
	let runningTasks = $state<VulnScanTask[]>([]);
	let allTasks = $state<VulnScanTask[]>([]);
	let selectedTaskId = $state<string | null>(null);
	let intervalId = $state<ReturnType<typeof setInterval> | null>(null);

	// é¡µé¢åŠ è½½æ—¶å¼€å§‹ç›‘æ§
	onMount(() => {
		loadTasks();
		startMonitoring();
	});

	// é¡µé¢å¸è½½æ—¶åœæ­¢ç›‘æ§
	onDestroy(() => {
		stopMonitoring();
	});

	// å¼€å§‹ç›‘æ§
	function startMonitoring() {
		if (intervalId) return;

		intervalId = setInterval(() => {
			loadTasks();
		}, refreshInterval);
	}

	// åœæ­¢ç›‘æ§
	function stopMonitoring() {
		if (intervalId) {
			clearInterval(intervalId);
			intervalId = null;
		}
	}

	// åŠ è½½ä»»åŠ¡åˆ—è¡¨
	async function loadTasks() {
		if (isLoading) return;

		isLoading = true;
		try {
			if (showAll) {
				// åŠ è½½æ‰€æœ‰ä»»åŠ¡
				await vulnStore.loadScanTasks({ pageSize: 50 });
				allTasks = get(scanTasks) || [];
			} else {
				// åªåŠ è½½è¿è¡Œä¸­çš„ä»»åŠ¡
				await vulnStore.loadScanTasks({
					status: 'running',
					pageSize: 50
				});
				runningTasks = get(scanTasks) || [];
			}
		} catch (error) {
			console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
			// ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œé¿å…é¢‘ç¹å¼¹å‡º
		} finally {
			isLoading = false;
		}
	}

	// è·å–è¦æ˜¾ç¤ºçš„ä»»åŠ¡åˆ—è¡¨
	function getDisplayTasks(): VulnScanTask[] {
		if (showAll) {
			return allTasks.filter((task) => ['pending', 'queued', 'running'].includes(task.status));
		}
		return runningTasks;
	}

	// åœæ­¢ä»»åŠ¡
	async function stopTask(task: VulnScanTask) {
		const success = await vulnStore.stopScanTask(task.id);
		if (success) {
			await loadTasks();
		}
	}

	// æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
	function viewTaskDetail(taskId: string) {
		window.open(`/vulnerability/results/${taskId}`, '_blank');
	}

	// è·å–çŠ¶æ€æ ·å¼
	function getStatusClass(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? `${config.bgColor} ${config.textColor}` : 'bg-gray-100 text-gray-800';
	}

	// è·å–çŠ¶æ€æ ‡ç­¾
	function getStatusLabel(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? config.label : status;
	}

	// è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
	function getProgressPercentage(task: VulnScanTask): number {
		return Math.round(task.progress || 0);
	}

	// æ ¼å¼åŒ–æ—¶é—´
	function formatTime(dateStr: string) {
		return new Date(dateStr).toLocaleTimeString('zh-CN');
	}

	// è®¡ç®—è¿è¡Œæ—¶é—´
	function getRunningTime(startTime: string): string {
		const start = new Date(startTime);
		const now = new Date();
		const diff = now.getTime() - start.getTime();

		const hours = Math.floor(diff / (1000 * 60 * 60));
		const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
		const seconds = Math.floor((diff % (1000 * 60)) / 1000);

		if (hours > 0) {
			return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
		} else {
			return `${minutes}:${seconds.toString().padStart(2, '0')}`;
		}
	}

	// è·å–ä¸¥é‡æ€§åˆ†å¸ƒ
	function getSeverityDistribution(task: VulnScanTask): SeverityDistributionItem[] {
		const summary = task.resultSummary;
		if (!summary) return [];

		const total = summary.totalVulns;
		if (total === 0) return [];

		return [
			{
				label: 'ä¸¥é‡',
				count: summary.criticalVulns,
				percentage: Math.round((summary.criticalVulns / total) * 100),
				color: 'bg-red-500'
			},
			{
				label: 'é«˜å±',
				count: summary.highVulns,
				percentage: Math.round((summary.highVulns / total) * 100),
				color: 'bg-orange-500'
			},
			{
				label: 'ä¸­å±',
				count: summary.mediumVulns,
				percentage: Math.round((summary.mediumVulns / total) * 100),
				color: 'bg-yellow-500'
			},
			{
				label: 'ä½å±',
				count: summary.lowVulns,
				percentage: Math.round((summary.lowVulns / total) * 100),
				color: 'bg-blue-500'
			},
			{
				label: 'ä¿¡æ¯',
				count: summary.infoVulns,
				percentage: Math.round((summary.infoVulns / total) * 100),
				color: 'bg-gray-500'
			}
		].filter((item) => item.count > 0);
	}

	// åˆ‡æ¢ç›‘æ§æ¨¡å¼
	function toggleMonitoring() {
		if (intervalId) {
			stopMonitoring();
		} else {
			startMonitoring();
		}
	}

	// æ‰‹åŠ¨åˆ·æ–°
	async function refresh() {
		await loadTasks();
		notifications.add({
			type: 'success',
			message: 'ä»»åŠ¡çŠ¶æ€å·²åˆ·æ–°'
		});
	}

	// å¯¼å‡ºç›‘æ§æ•°æ®
	function exportMonitoringData() {
		const tasks = getDisplayTasks();
		const data = tasks.map((task) => ({
			id: task.id,
			name: task.taskName,
			status: task.status,
			progress: task.progress,
			vulnerabilities: task.resultSummary?.totalVulns || 0,
			startTime: task.startedAt,
			targets: task.targets.length
		}));

		const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `scan-monitoring-${new Date().toISOString().split('T')[0]}.json`;
		a.click();
		URL.revokeObjectURL(url);
	}
</script>

<div class="space-y-6">
	<!-- ç›‘æ§æ§åˆ¶æ  -->
	<Card>
		<CardContent class="p-4">
			<div class="flex justify-between items-center">
				<div class="flex items-center gap-4">
					<h2 class="text-lg font-semibold text-gray-900">
						{showAll ? 'ä»»åŠ¡ç›‘æ§' : 'è¿è¡Œä¸­ä»»åŠ¡ç›‘æ§'}
					</h2>
					<div class="flex items-center gap-2">
						<div class="w-2 h-2 rounded-full {intervalId ? 'bg-green-500' : 'bg-red-500'}"></div>
						<span class="text-sm text-gray-600">
							{intervalId ? 'å®æ—¶ç›‘æ§ä¸­' : 'ç›‘æ§å·²æš‚åœ'}
						</span>
					</div>
				</div>

				<div class="flex items-center gap-3">
					<label class="flex items-center gap-2 text-sm">
						<input
							type="checkbox"
							bind:checked={showAll}
							onchange={loadTasks}
							class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
						/>
						æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡
					</label>

					<Button size="sm" variant="outline" onclick={exportMonitoringData}>å¯¼å‡ºæ•°æ®</Button>

					<Button size="sm" variant="outline" onclick={refresh} disabled={isLoading}>
						{isLoading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}
					</Button>

					<Button
						size="sm"
						variant={intervalId ? 'destructive' : 'default'}
						onclick={toggleMonitoring}
					>
						{intervalId ? 'æš‚åœç›‘æ§' : 'å¼€å§‹ç›‘æ§'}
					</Button>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- ä»»åŠ¡ç›‘æ§åˆ—è¡¨ -->
	{#if getDisplayTasks().length > 0}
		<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
			{#each getDisplayTasks() as task (task.id)}
				<Card
					class="hover:shadow-lg transition-shadow cursor-pointer"
					onclick={() => (selectedTaskId = selectedTaskId === task.id ? null : task.id)}
				>
					<CardHeader class="pb-3">
						<div class="flex justify-between items-start">
							<CardTitle class="text-lg font-semibold text-gray-900 truncate">
								{task.taskName}
							</CardTitle>
							<Badge class={getStatusClass(task.status)}>
								{getStatusLabel(task.status)}
							</Badge>
						</div>
					</CardHeader>

					<CardContent>
						<div class="space-y-4">
							<!-- è¿›åº¦æ¡ -->
							{#if task.status === 'running'}
								<div>
									<div class="flex justify-between items-center mb-1">
										<span class="text-sm font-medium text-gray-700">æ‰«æè¿›åº¦</span>
										<span class="text-sm text-gray-600">{getProgressPercentage(task)}%</span>
									</div>
									<div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
										<div
											class="h-full bg-blue-500 transition-all duration-500"
											style="width: {getProgressPercentage(task)}%"
										></div>
									</div>
									<div class="text-xs text-gray-500 mt-1">
										{task.resultSummary?.scannedTargets || 0} / {task.resultSummary?.totalTargets ||
											0} ä¸ªç›®æ ‡
									</div>
								</div>
							{/if}

							<!-- åŸºæœ¬ä¿¡æ¯ -->
							<div class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<div class="text-gray-500">ç›®æ ‡æ•°é‡</div>
									<div class="font-medium">{task.targets.length}</div>
								</div>
								<div>
									<div class="text-gray-500">å‘ç°æ¼æ´</div>
									<div class="font-medium text-red-600">{task.resultSummary?.totalVulns || 0}</div>
								</div>
								{#if task.startedAt}
									<div>
										<div class="text-gray-500">å¼€å§‹æ—¶é—´</div>
										<div class="font-medium">{formatTime(task.startedAt)}</div>
									</div>
									<div>
										<div class="text-gray-500">è¿è¡Œæ—¶é—´</div>
										<div class="font-medium">{getRunningTime(task.startedAt)}</div>
									</div>
								{/if}
							</div>

							<!-- æ¼æ´ä¸¥é‡æ€§åˆ†å¸ƒ -->
							{#if task.resultSummary && task.resultSummary.totalVulns > 0}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-2">æ¼æ´åˆ†å¸ƒ</div>
									<div class="flex h-2 bg-gray-200 rounded-full overflow-hidden">
										{#each getSeverityDistribution(task) as item}
											<div
												class={item.color}
												style="width: {item.percentage}%"
												title="{item.label}: {item.count}"
											></div>
										{/each}
									</div>
									<div class="flex justify-between text-xs text-gray-500 mt-1">
										{#each getSeverityDistribution(task) as item}
											<span>{item.label}: {item.count}</span>
										{/each}
									</div>
								</div>
							{/if}

							<!-- é”™è¯¯ä¿¡æ¯ -->
							{#if task.error}
								<div class="bg-red-50 border border-red-200 text-red-800 p-2 rounded text-xs">
									é”™è¯¯: {task.error}
								</div>
							{/if}

							<!-- å±•å¼€çš„è¯¦ç»†ä¿¡æ¯ -->
							{#if selectedTaskId === task.id}
								<div class="border-t border-gray-200 pt-4 space-y-3">
									<!-- ç›®æ ‡é¢„è§ˆ -->
									<div>
										<div class="text-sm font-medium text-gray-700 mb-1">æ‰«æç›®æ ‡</div>
										<div class="max-h-20 overflow-y-auto text-xs text-gray-600 space-y-1">
											{#each task.targets.slice(0, 5) as target}
												<div class="font-mono truncate">{target}</div>
											{/each}
											{#if task.targets.length > 5}
												<div class="text-gray-500">...è¿˜æœ‰ {task.targets.length - 5} ä¸ªç›®æ ‡</div>
											{/if}
										</div>
									</div>

									<!-- é…ç½®ä¿¡æ¯ -->
									<div class="grid grid-cols-2 gap-2 text-xs">
										<div>
											<span class="text-gray-500">å¹¶å‘æ•°:</span>
											<span class="ml-1">{task.config.concurrency}</span>
										</div>
										<div>
											<span class="text-gray-500">è¶…æ—¶:</span>
											<span class="ml-1">{task.config.timeout}s</span>
										</div>
										<div>
											<span class="text-gray-500">POCæ•°:</span>
											<span class="ml-1">{task.config.pocIds?.length || 0}</span>
										</div>
										<div>
											<span class="text-gray-500">èŠ‚ç‚¹:</span>
											<span class="ml-1">{task.nodeId || 'local'}</span>
										</div>
									</div>

									<!-- æ“ä½œæŒ‰é’® -->
									<div class="flex gap-2">
										<Button
											size="sm"
											onclick={(e: Event) => {
												e.stopPropagation();
												viewTaskDetail(task.id);
											}}
										>
											æŸ¥çœ‹è¯¦æƒ…
										</Button>

										{#if task.status === 'running'}
											<Button
												size="sm"
												variant="destructive"
												onclick={(e: Event) => {
													e.stopPropagation();
													stopTask(task);
												}}
											>
												åœæ­¢
											</Button>
										{/if}
									</div>
								</div>
							{/if}
						</div>
					</CardContent>
				</Card>
			{/each}
		</div>
	{:else}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">
				{showAll ? 'ğŸ“Š' : 'â±ï¸'}
			</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">
				{showAll ? 'æš‚æ— ä»»åŠ¡' : 'æš‚æ— è¿è¡Œä¸­çš„ä»»åŠ¡'}
			</h3>
			<p class="text-gray-500">
				{showAll ? 'è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ‰«æä»»åŠ¡' : 'å½“å‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„æ‰«æä»»åŠ¡'}
			</p>
		</div>
	{/if}

	<!-- ç›‘æ§ç»Ÿè®¡ -->
	{#if getDisplayTasks().length > 0}
		<Card>
			<CardHeader>
				<CardTitle>ç›‘æ§ç»Ÿè®¡</CardTitle>
			</CardHeader>
			<CardContent>
				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div class="text-center">
						<div class="text-2xl font-bold text-blue-600">
							{getDisplayTasks().filter((t) => t.status === 'running').length}
						</div>
						<div class="text-sm text-gray-600">è¿è¡Œä¸­</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-yellow-600">
							{getDisplayTasks().filter((t) => ['pending', 'queued'].includes(t.status)).length}
						</div>
						<div class="text-sm text-gray-600">ç­‰å¾…ä¸­</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-green-600">
							{getDisplayTasks().reduce((sum, t) => sum + (t.resultSummary?.totalVulns || 0), 0)}
						</div>
						<div class="text-sm text-gray-600">å‘ç°æ¼æ´</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-purple-600">
							{getDisplayTasks().reduce((sum, t) => sum + t.targets.length, 0)}
						</div>
						<div class="text-sm text-gray-600">æ‰«æç›®æ ‡</div>
					</div>
				</div>
			</CardContent>
		</Card>
	{/if}
</div>
