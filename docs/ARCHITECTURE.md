# StellarServer 重构后架构文档

## 项目结构优化

### 新目录结构
```
/root/Stellar/
├── cmd/                          # 应用程序入口点
│   ├── main.go                   # 主入口
│   ├── server/                   # 服务器启动相关
│   └── migrate/                  # 数据库迁移工具
├── internal/                     # 内部代码包
│   ├── api/                      # API层
│   │   ├── handlers/             # HTTP处理器
│   │   ├── middleware/           # 中间件
│   │   ├── router/               # 路由配置
│   │   └── validators/           # 请求验证器
│   ├── core/                     # 核心业务逻辑层
│   │   ├── domain/               # 领域模型和接口
│   │   ├── services/             # 业务服务
│   │   └── usecases/             # 用例层
│   ├── infrastructure/           # 基础设施层
│   │   ├── database/             # 数据库连接和配置
│   │   ├── repository/           # 数据访问层
│   │   ├── cache/                # 缓存管理
│   │   ├── queue/                # 消息队列
│   │   └── external/             # 外部服务集成
│   ├── config/                   # 配置管理
│   ├── models/                   # 数据模型
│   ├── pkg/                      # 可重用包
│   │   ├── errors/               # 错误处理
│   │   ├── logger/               # 日志
│   │   ├── utils/                # 工具函数
│   │   └── security/             # 安全相关
│   └── plugins/                  # 插件系统
├── migrations/                   # 数据库迁移文件
├── configs/                      # 配置文件
├── docs/                         # 文档
├── scripts/                      # 脚本文件
├── tests/                        # 测试文件
└── web/                          # 前端代码
```

## 架构分层

### 1. 表现层 (Presentation Layer)
- **位置**: `internal/api/`
- **职责**: HTTP请求处理、路由、中间件、请求验证
- **组件**:
  - Handlers: 处理HTTP请求
  - Middleware: 认证、授权、日志、CORS等
  - Router: 路由配置和管理
  - Validators: 请求参数验证

### 2. 应用层 (Application Layer)
- **位置**: `internal/core/usecases/`
- **职责**: 业务用例编排、跨服务协调
- **组件**:
  - Use Cases: 具体的业务用例实现
  - DTOs: 数据传输对象

### 3. 领域层 (Domain Layer)
- **位置**: `internal/core/domain/`
- **职责**: 核心业务逻辑、实体、值对象、领域服务
- **组件**:
  - Entities: 业务实体
  - Value Objects: 值对象
  - Domain Services: 领域服务
  - Repositories: 仓储接口

### 4. 基础设施层 (Infrastructure Layer)
- **位置**: `internal/infrastructure/`
- **职责**: 外部依赖实现、数据持久化、缓存、消息队列
- **组件**:
  - Database: 数据库连接和配置
  - Repository: 仓储实现
  - Cache: 缓存实现
  - Queue: 消息队列实现
  - External: 外部服务客户端

## 技术架构

### 数据库架构
- **主数据库**: 支持 MySQL/PostgreSQL/SQLite (使用GORM)
- **MongoDB**: 保持向后兼容，用于复杂文档存储
- **Redis**: 缓存和消息队列
- **多数据库支持**: 统一的数据访问层

### 依赖注入
- **容器**: 使用依赖注入容器管理服务依赖
- **接口隔离**: 通过接口解耦具体实现
- **配置驱动**: 基于配置选择具体实现

### 插件系统
- **多语言支持**: Go、Python、YAML插件
- **沙箱执行**: 安全的插件执行环境
- **热加载**: 动态插件加载和卸载
- **插件市场**: 插件分发和管理

### 中间件架构
- **认证中间件**: JWT认证
- **授权中间件**: RBAC权限控制
- **日志中间件**: 请求/响应日志
- **限流中间件**: API限流保护
- **CORS中间件**: 跨域资源共享
- **恢复中间件**: Panic恢复

### 错误处理
- **统一错误类型**: 标准化错误结构
- **错误链**: 错误追踪和上下文
- **错误码**: 标准化错误代码
- **错误日志**: 结构化错误日志

### 配置管理
- **多环境支持**: dev/test/prod配置
- **环境变量覆盖**: 支持环境变量配置
- **配置验证**: 启动时配置验证
- **热重载**: 配置文件热重载

### 监控和观测
- **健康检查**: 多层次健康检查
- **指标收集**: Prometheus指标
- **分布式追踪**: OpenTelemetry支持
- **日志聚合**: 结构化日志输出

## 代码规范

### 命名规范
- 包名: 小写，简短，有意义
- 接口: 以`er`结尾，如`UserRepository`
- 结构体: 驼峰命名，清晰描述职责
- 方法: 驼峰命名，动词开头

### 目录规范
- 按层级组织代码
- 接口和实现分离
- 测试文件就近放置
- 公共包放在`pkg/`目录

### 依赖规则
- 高层不依赖低层具体实现
- 依赖接口而非具体类型
- 避免循环依赖
- 明确依赖边界

## 迁移策略

### 阶段1: 基础架构重构
1. 创建新的目录结构
2. 重构数据库连接层
3. 实现统一的路由管理
4. 添加基础中间件

### 阶段2: 业务逻辑重构
1. 抽取领域模型
2. 实现仓储模式
3. 重构业务服务
4. 添加用例层

### 阶段3: 高级特性
1. 实现依赖注入
2. 完善错误处理
3. 添加监控指标
4. 优化性能

### 阶段4: 测试和文档
1. 完善单元测试
2. 添加集成测试
3. 完善API文档
4. 性能测试

## 技术收益

### 可维护性
- 清晰的代码结构
- 低耦合高内聚
- 统一的编码规范
- 完善的文档

### 可扩展性
- 插件化架构
- 微服务友好
- 水平扩展支持
- 模块化设计

### 可测试性
- 依赖注入支持
- 接口模拟
- 集成测试
- 性能测试

### 性能
- 数据库连接池
- 缓存层优化
- 异步处理
- 负载均衡