<script lang="ts">
	import { onMount } from 'svelte';
	import { goto } from '$app/navigation';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		pocList,
		pocPagination,
		pocFilters,
		selectedPOC
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { SEVERITY_CONFIG, TYPE_CONFIG } from '$lib/types/vulnerability';
	import type { POC, VulnerabilitySeverity, VulnerabilityType } from '$lib/types/vulnerability';

	// å¤–éƒ¨å›è°ƒå±æ€§
	let { onCreatePOC = () => {}, onEditPOC = () => {} } = $props();

	// ç»„ä»¶çŠ¶æ€
	let isLoading = $state(false);
	let showCreateDialog = $state(false);
	let showEditDialog = $state(false);
	let showDeleteDialog = $state(false);
	let currentPOC = $state<POC | null>(null);

	// åˆ—è¡¨çŠ¶æ€
	let pocs = $state<POC[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		type: undefined as VulnerabilityType | undefined,
		category: undefined as string | undefined,
		severity: undefined as VulnerabilitySeverity | undefined,
		enabled: undefined as boolean | undefined,
		search: undefined as string | undefined
	});

	// è®¢é˜… store å˜åŒ–
	$effect(() => {
		const unsubscribePOCs = pocList.subscribe((value) => (pocs = value));
		const unsubscribePagination = pocPagination.subscribe((value) => (pagination = value));
		const unsubscribeFilters = pocFilters.subscribe((value) => (filters = value));

		return () => {
			unsubscribePOCs();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
	onMount(() => {
		loadPOCs();
	});

	// åŠ è½½POCåˆ—è¡¨
	async function loadPOCs() {
		isLoading = true;
		try {
			await vulnStore.loadPOCs({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: 'åŠ è½½POCåˆ—è¡¨å¤±è´¥: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// åˆ†é¡µå¤„ç†
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadPOCs();
	}

	// è¿‡æ»¤å¤„ç†
	function handleFilterChange() {
		pagination.page = 1;
		loadPOCs();
	}

	// æœç´¢å¤„ç†
	function handleSearch(event: Event) {
		const target = event.target as HTMLInputElement;
		filters.search = target.value || undefined;
		handleFilterChange();
	}

	// ç¼–è¾‘POC
	function editPOC(poc: POC) {
		onEditPOC(poc);
	}

	// åˆ é™¤POC
	function deletePOC(poc: POC) {
		currentPOC = poc;
		showDeleteDialog = true;
	}

	// ç¡®è®¤åˆ é™¤POC
	async function confirmDelete() {
		if (!currentPOC) return;

		const success = await vulnStore.deletePOC(currentPOC.id);
		if (success) {
			showDeleteDialog = false;
			currentPOC = null;
			loadPOCs();
		}
	}

	// åˆ‡æ¢POCå¯ç”¨çŠ¶æ€
	async function togglePOCEnabled(poc: POC) {
		const success = await vulnStore.updatePOC(poc.id, {
			enabled: !poc.enabled
		});
		if (success) {
			loadPOCs();
		}
	}

	// æµ‹è¯•POC
	async function testPOC(poc: POC) {
		const target = prompt('è¯·è¾“å…¥æµ‹è¯•ç›®æ ‡URL:', 'http://example.com');
		if (!target) return;

		const result = await vulnStore.testPOC(poc.id, target);
		if (result) {
			notifications.add({
				type: result.success ? 'success' : 'info',
				message: `POCæµ‹è¯•${result.success ? 'æˆåŠŸ' : 'å¤±è´¥'}: ${result.output || result.error}`
			});
		}
	}

	// è·å–ä¸¥é‡æ€§æ ·å¼
	function getSeverityClass(severity: VulnerabilitySeverity) {
		const config = SEVERITY_CONFIG[severity];
		return `${config.bgColor} ${config.textColor} ${config.borderColor}`;
	}

	// è·å–ç±»å‹é…ç½®
	function getTypeConfig(type: VulnerabilityType) {
		return TYPE_CONFIG[type];
	}

	// æ ¼å¼åŒ–æ—¥æœŸ
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN');
	}
</script>

<div class="container mx-auto p-6">
	<!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæ  -->
	<div class="flex justify-between items-center mb-6">
		<div>
			<h1 class="text-3xl font-bold text-gray-900">POCç®¡ç†</h1>
			<p class="text-gray-600 mt-1">ç®¡ç†æ¼æ´æ£€æµ‹POCè„šæœ¬</p>
		</div>
		<div class="flex gap-3">
			<Button onclick={() => loadPOCs()} variant="outline" disabled={isLoading}>
				{isLoading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}
			</Button>
			<Button onclick={() => onCreatePOC()}>åˆ›å»ºPOC</Button>
		</div>
	</div>

	<!-- è¿‡æ»¤å’Œæœç´¢æ  -->
	<Card class="mb-6">
		<CardContent class="p-4">
			<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
				<!-- æœç´¢æ¡† -->
				<div>
					<label for="poc-search" class="block text-sm font-medium text-gray-700 mb-1">æœç´¢</label>
					<input
						id="poc-search"
						type="text"
						value={filters.search || ''}
						onkeyup={handleSearch}
						placeholder="æœç´¢POCåç§°æˆ–æè¿°..."
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<!-- ç±»å‹è¿‡æ»¤ -->
				<div>
					<label for="poc-type-filter" class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹</label>
					<select
						id="poc-type-filter"
						bind:value={filters.type}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>å…¨éƒ¨ç±»å‹</option>
						<option value="web">Webæ¼æ´</option>
						<option value="system">ç³»ç»Ÿæ¼æ´</option>
						<option value="network">ç½‘ç»œæ¼æ´</option>
						<option value="config">é…ç½®æ¼æ´</option>
						<option value="component">ç»„ä»¶æ¼æ´</option>
					</select>
				</div>

				<!-- ä¸¥é‡æ€§è¿‡æ»¤ -->
				<div>
					<label for="poc-severity-filter" class="block text-sm font-medium text-gray-700 mb-1">ä¸¥é‡æ€§</label>
					<select
						id="poc-severity-filter"
						bind:value={filters.severity}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>å…¨éƒ¨ä¸¥é‡æ€§</option>
						<option value="critical">ä¸¥é‡</option>
						<option value="high">é«˜å±</option>
						<option value="medium">ä¸­å±</option>
						<option value="low">ä½å±</option>
						<option value="info">ä¿¡æ¯</option>
					</select>
				</div>

				<!-- çŠ¶æ€è¿‡æ»¤ -->
				<div>
					<label for="poc-status-filter" class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
					<select
						id="poc-status-filter"
						bind:value={filters.enabled}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>å…¨éƒ¨çŠ¶æ€</option>
						<option value={true}>å·²å¯ç”¨</option>
						<option value={false}>å·²ç¦ç”¨</option>
					</select>
				</div>

				<!-- åˆ†ç±»è¿‡æ»¤ -->
				<div>
					<label for="poc-category-filter" class="block text-sm font-medium text-gray-700 mb-1">åˆ†ç±»</label>
					<input
						id="poc-category-filter"
						type="text"
						bind:value={filters.category}
						onchange={handleFilterChange}
						placeholder="è¾“å…¥åˆ†ç±»åç§°..."
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- POCåˆ—è¡¨ -->
	<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
		{#each pocs as poc (poc.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardHeader class="pb-3">
					<div class="flex justify-between items-start">
						<CardTitle class="text-lg font-semibold text-gray-900 truncate">
							{poc.name}
						</CardTitle>
						<div class="flex gap-2 ml-2">
							<Badge class={getSeverityClass(poc.severity)}>
								{SEVERITY_CONFIG[poc.severity].label}
							</Badge>
							<Badge variant={poc.enabled ? 'default' : 'secondary'}>
								{poc.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
							</Badge>
						</div>
					</div>
				</CardHeader>

				<CardContent>
					<div class="space-y-3">
						<!-- åŸºæœ¬ä¿¡æ¯ -->
						<div>
							<p class="text-sm text-gray-600 line-clamp-2">{poc.description}</p>
						</div>

						<!-- è¯¦ç»†ä¿¡æ¯ -->
						<div class="grid grid-cols-2 gap-2 text-xs text-gray-500">
							<div>
								<span class="font-medium">ç±»å‹:</span>
								<span class="ml-1">{getTypeConfig(poc.type).label}</span>
							</div>
							<div>
								<span class="font-medium">åˆ†ç±»:</span>
								<span class="ml-1">{poc.category}</span>
							</div>
							<div>
								<span class="font-medium">ä½œè€…:</span>
								<span class="ml-1">{poc.author}</span>
							</div>
							<div>
								<span class="font-medium">è„šæœ¬:</span>
								<span class="ml-1">{poc.scriptType.toUpperCase()}</span>
							</div>
						</div>

						<!-- CVE/CWEä¿¡æ¯ -->
						{#if poc.cveId || poc.cweId}
							<div class="flex gap-2">
								{#if poc.cveId}
									<Badge variant="outline" class="text-xs">{poc.cveId}</Badge>
								{/if}
								{#if poc.cweId}
									<Badge variant="outline" class="text-xs">{poc.cweId}</Badge>
								{/if}
							</div>
						{/if}

						<!-- ç»Ÿè®¡ä¿¡æ¯ -->
						{#if poc.runCount > 0}
							<div class="text-xs text-gray-500">
								<span>æ‰§è¡Œæ¬¡æ•°: {poc.runCount}</span>
								<span class="mx-2">|</span>
								<span>æˆåŠŸç‡: {(poc.successRate * 100).toFixed(1)}%</span>
							</div>
						{/if}

						<!-- æ ‡ç­¾ -->
						{#if poc.tags && poc.tags.length > 0}
							<div class="flex flex-wrap gap-1">
								{#each poc.tags.slice(0, 3) as tag}
									<Badge variant="outline" class="text-xs">{tag}</Badge>
								{/each}
								{#if poc.tags.length > 3}
									<Badge variant="outline" class="text-xs">+{poc.tags.length - 3}</Badge>
								{/if}
							</div>
						{/if}

						<!-- æ“ä½œæŒ‰é’® -->
						<div class="flex justify-between items-center pt-2 border-t border-gray-100">
							<div class="flex gap-2">
								<Button size="sm" variant="outline" onclick={() => testPOC(poc)}>æµ‹è¯•</Button>
								<Button size="sm" variant="outline" onclick={() => editPOC(poc)}>ç¼–è¾‘</Button>
							</div>
							<div class="flex gap-2">
								<Button
									size="sm"
									variant={poc.enabled ? 'outline' : 'default'}
									onclick={() => togglePOCEnabled(poc)}
								>
									{poc.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
								</Button>
								<Button size="sm" variant="destructive" onclick={() => deletePOC(poc)}>åˆ é™¤</Button>
							</div>
						</div>

						<!-- æ—¶é—´ä¿¡æ¯ -->
						<div class="text-xs text-gray-400 pt-1">
							åˆ›å»ºäº: {formatDate(poc.createdAt)}
							{#if poc.updatedAt !== poc.createdAt}
								<span class="mx-2">|</span>
								æ›´æ–°äº: {formatDate(poc.updatedAt)}
							{/if}
						</div>
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{#if !isLoading && pocs.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">ğŸ“‹</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">æš‚æ— POC</h3>
			<p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•POCè„šæœ¬</p>
			<Button onclick={() => onCreatePOC()}>åˆ›å»ºç¬¬ä¸€ä¸ªPOC</Button>
		</div>
	{/if}

	<!-- åˆ†é¡µ -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center mt-8">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					ä¸Šä¸€é¡µ
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					ç¬¬ {pagination.page} é¡µï¼Œå…± {pagination.totalPages} é¡µ
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					ä¸‹ä¸€é¡µ
				</Button>
			</div>
		</div>
	{/if}

	<!-- åŠ è½½çŠ¶æ€ -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">åŠ è½½ä¸­...</p>
			</div>
		</div>
	{/if}
</div>

<!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
{#if showDeleteDialog && currentPOC}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
			<h3 class="text-lg font-semibold text-gray-900 mb-2">ç¡®è®¤åˆ é™¤</h3>
			<p class="text-gray-600 mb-4">
				ç¡®å®šè¦åˆ é™¤POC "{currentPOC.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
			</p>
			<div class="flex justify-end gap-3">
				<Button variant="outline" onclick={() => (showDeleteDialog = false)}>å–æ¶ˆ</Button>
				<Button variant="destructive" onclick={confirmDelete}>ç¡®è®¤åˆ é™¤</Button>
			</div>
		</div>
	</div>
{/if}

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
