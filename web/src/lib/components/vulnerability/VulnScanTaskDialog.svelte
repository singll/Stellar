<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import { vulnStore, pocList } from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import type {
		VulnScanTask,
		VulnScanConfig,
		POC,
		VulnerabilitySeverity
	} from '$lib/types/vulnerability';

	let {
		task = null,
		isOpen = $bindable(false),
		open = $bindable(false), // 添加 open 属性
		onSave = () => {},
		onCancel = () => {}
	} = $props();

	// 表单数据
	let formData = $state({
		projectId: '',
		taskName: '',
		targets: [] as string[],
		targetType: 'url',
		config: {
			pocIds: [] as string[],
			pocCategories: [] as string[],
			concurrency: 10,
			timeout: 30,
			retryCount: 3,
			rateLimit: 10,
			followRedirect: true,
			customHeaders: {} as Record<string, string>,
			cookies: '',
			proxy: '',
			scanDepth: 1,
			saveToDB: true,
			verifyVuln: true,
			minimumSeverity: 'info' as VulnerabilitySeverity
		} as VulnScanConfig,
		tags: [] as string[]
	});

	// POC列表和选择状态
	let availablePOCs = $state<POC[]>([]);
	let selectedPOCs = $state<string[]>([]);
	let isSaving = $state(false);

	// 表单验证错误
	let errors = $state({
		taskName: '',
		targets: '',
		projectId: ''
	});

	// 文本输入辅助状态
	let targetsInput = $state('');
	let tagsInput = $state('');
	let customHeadersInput = $state('');

	// 同步 isOpen 和 open 属性
	$effect(() => {
		if (open !== undefined) {
			isOpen = open;
		}
	});

	$effect(() => {
		if (open !== undefined) {
			open = isOpen;
		}
	});

	// 当 task 属性变化时，更新表单数据
	$effect(() => {
		if (task) {
			formData = {
				projectId: task.projectId,
				taskName: task.taskName,
				targets: [...task.targets],
				targetType: task.targetType,
				config: { ...task.config },
				tags: [...task.tags]
			};

			selectedPOCs = [...(task.config.pocIds || [])];
			targetsInput = task.targets.join('\n');
			tagsInput = task.tags.join(', ');
			customHeadersInput = Object.entries(task.config.customHeaders || {})
				.map(([k, v]) => `${k}: ${v}`)
				.join('\n');
		} else {
			resetForm();
		}
	});

	// 订阅POC列表
	$effect(() => {
		const unsubscribe = pocList.subscribe((pocs) => {
			availablePOCs = pocs;
		});
		return unsubscribe;
	});

	// 加载POC列表
	onMount(async () => {
		await vulnStore.loadPOCs();
	});

	// 重置表单
	function resetForm() {
		formData = {
			projectId: '',
			taskName: '',
			targets: [],
			targetType: 'url',
			config: {
				pocIds: [],
				pocCategories: [],
				concurrency: 10,
				timeout: 30,
				retryCount: 3,
				rateLimit: 10,
				followRedirect: true,
				customHeaders: {},
				cookies: '',
				proxy: '',
				scanDepth: 1,
				saveToDB: true,
				verifyVuln: true,
				minimumSeverity: 'info'
			},
			tags: []
		};

		selectedPOCs = [];
		targetsInput = '';
		tagsInput = '';
		customHeadersInput = '';

		errors = {
			taskName: '',
			targets: '',
			projectId: ''
		};
	}

	// 验证表单
	function validateForm(): boolean {
		errors = {
			taskName: '',
			targets: '',
			projectId: ''
		};

		let isValid = true;

		if (!formData.taskName.trim()) {
			errors.taskName = '任务名称不能为空';
			isValid = false;
		}

		if (!formData.projectId) {
			errors.projectId = '请选择项目';
			isValid = false;
		}

		if (formData.targets.length === 0) {
			errors.targets = '至少需要一个扫描目标';
			isValid = false;
		}

		return isValid;
	}

	// 解析输入数据
	function parseInputs() {
		// 解析targets
		formData.targets = targetsInput
			.split('\n')
			.map((s) => s.trim())
			.filter((s) => s.length > 0);

		// 解析tags
		formData.tags = tagsInput
			.split(',')
			.map((s) => s.trim())
			.filter((s) => s.length > 0);

		// 解析customHeaders
		formData.config.customHeaders = {};
		customHeadersInput
			.split('\n')
			.map((s) => s.trim())
			.filter((s) => s.length > 0)
			.forEach((line) => {
				const [key, ...values] = line.split(':');
				if (key && values.length > 0) {
					formData.config.customHeaders[key.trim()] = values.join(':').trim();
				}
			});

		// 设置选中的POC
		formData.config.pocIds = selectedPOCs;
	}

	// POC选择处理
	function togglePOCSelection(pocId: string) {
		if (selectedPOCs.includes(pocId)) {
			selectedPOCs = selectedPOCs.filter((id) => id !== pocId);
		} else {
			selectedPOCs = [...selectedPOCs, pocId];
		}
	}

	// 选择所有POC
	function selectAllPOCs() {
		selectedPOCs = availablePOCs.map((poc) => poc.id);
	}

	// 清空POC选择
	function clearPOCSelection() {
		selectedPOCs = [];
	}

	// 按分类选择POC
	function selectPOCsByCategory(category: string) {
		const categoryPOCs = availablePOCs
			.filter((poc) => poc.category === category)
			.map((poc) => poc.id);

		selectedPOCs = [...new Set([...selectedPOCs, ...categoryPOCs])];
	}

	// 保存任务
	async function save() {
		if (!validateForm()) {
			return;
		}

		parseInputs();

		isSaving = true;

		try {
			let result;
			if (task) {
				// 更新现有任务 - 注意：一般运行中的任务不能编辑
				// result = await vulnStore.updateScanTask(task.id, formData);
				notifications.add({
					type: 'warning',
					message: '任务编辑功能暂未实现'
				});
				return;
			} else {
				// 创建新任务
				result = await vulnStore.createScanTask(formData);
			}

			if (result) {
				onSave(result);
				isOpen = false;
				resetForm();
			}
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '保存失败: ' + errorMessage
			});
		} finally {
			isSaving = false;
		}
	}

	// 取消操作
	function cancel() {
		onCancel();
		isOpen = false;
		resetForm();
	}

	// 获取分类列表
	function getCategories(): string[] {
		const categories = new Set(availablePOCs.map((poc) => poc.category));
		return Array.from(categories).sort();
	}

	// 获取已选POC的分类统计
	function getSelectedCategoryStats(): Record<string, number> {
		const stats: Record<string, number> = {};
		selectedPOCs.forEach((pocId) => {
			const poc = availablePOCs.find((p) => p.id === pocId);
			if (poc) {
				(stats as any)[poc.category] = ((stats as any)[poc.category] || 0) + 1;
			}
		});
		return stats;
	}

	// 目标类型选项
	const targetTypes = [
		{ value: 'url', label: 'URL地址' },
		{ value: 'domain', label: '域名' },
		{ value: 'ip', label: 'IP地址' },
		{ value: 'cidr', label: 'IP段(CIDR)' }
	];
</script>

{#if isOpen}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
		<div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto">
			<Card>
				<CardHeader>
					<CardTitle>
						{task ? '编辑扫描任务' : '创建扫描任务'}
					</CardTitle>
				</CardHeader>

				<CardContent class="space-y-6">
					<!-- 基本信息 -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="task-name" class="block text-sm font-medium text-gray-700 mb-1">
								任务名称 <span class="text-red-500">*</span>
							</label>
							<input
								id="task-name"
								type="text"
								bind:value={formData.taskName}
								placeholder="输入任务名称..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								class:border-red-500={errors.taskName}
							/>
							{#if errors.taskName}
								<p class="text-red-500 text-xs mt-1">{errors.taskName}</p>
							{/if}
						</div>

						<div>
							<label for="task-project" class="block text-sm font-medium text-gray-700 mb-1">
								项目 <span class="text-red-500">*</span>
							</label>
							<select
								id="task-project"
								bind:value={formData.projectId}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								class:border-red-500={errors.projectId}
							>
								<option value="">请选择项目</option>
								<!-- 这里应该动态加载项目列表 -->
								<option value="project1">测试项目1</option>
								<option value="project2">测试项目2</option>
							</select>
							{#if errors.projectId}
								<p class="text-red-500 text-xs mt-1">{errors.projectId}</p>
							{/if}
						</div>

						<div>
							<label for="target-type" class="block text-sm font-medium text-gray-700 mb-1">目标类型</label>
							<select
								id="target-type"
								bind:value={formData.targetType}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							>
								{#each targetTypes as type}
									<option value={type.value}>{type.label}</option>
								{/each}
							</select>
						</div>

						<div>
							<label for="min-severity" class="block text-sm font-medium text-gray-700 mb-1">最低严重性</label>
							<select
								id="min-severity"
								bind:value={formData.config.minimumSeverity}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							>
								<option value="info">信息</option>
								<option value="low">低危</option>
								<option value="medium">中危</option>
								<option value="high">高危</option>
								<option value="critical">严重</option>
							</select>
						</div>
					</div>

					<!-- 扫描目标 -->
					<div>
						<label for="scan-targets" class="block text-sm font-medium text-gray-700 mb-1">
							扫描目标 <span class="text-red-500">*</span>
						</label>
						<textarea
							id="scan-targets"
							bind:value={targetsInput}
							rows={5}
							placeholder="每行一个目标，如：
https://example.com
https://test.com/api
192.168.1.1
10.0.0.0/24"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							class:border-red-500={errors.targets}
						></textarea>
						{#if errors.targets}
							<p class="text-red-500 text-xs mt-1">{errors.targets}</p>
						{/if}
						<p class="text-xs text-gray-500 mt-1">
							每行输入一个目标，支持URL、域名、IP、IP段等格式
						</p>
					</div>

					<!-- POC选择 -->
					<div>
						<div class="flex justify-between items-center mb-3">
							<span class="block text-sm font-medium text-gray-700">
								选择POC ({selectedPOCs.length}/{availablePOCs.length})
							</span>
							<div class="flex gap-2">
								<Button size="sm" variant="outline" onclick={selectAllPOCs}>全选</Button>
								<Button size="sm" variant="outline" onclick={clearPOCSelection}>清空</Button>
							</div>
						</div>

						<!-- 按分类选择 -->
						<div class="mb-3">
							<div class="text-sm text-gray-600 mb-2">按分类选择：</div>
							<div class="flex flex-wrap gap-2">
								{#each getCategories() as category}
									<Button
										size="sm"
										variant="outline"
										onclick={() => selectPOCsByCategory(category)}
									>
										{category}
									</Button>
								{/each}
							</div>
						</div>

						<!-- 已选择的分类统计 -->
						{#if selectedPOCs.length > 0}
							<div class="mb-3 p-3 bg-blue-50 rounded-md">
								<div class="text-sm text-blue-800 font-medium mb-1">已选择POC分类统计：</div>
								<div class="flex flex-wrap gap-2">
									{#each Object.entries(getSelectedCategoryStats()) as [category, count]}
										<Badge variant="outline" class="text-xs">
											{category}: {count}
										</Badge>
									{/each}
								</div>
							</div>
						{/if}

						<!-- POC列表 -->
						<div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
							{#each availablePOCs as poc (poc.id)}
								<div class="flex items-center p-3 border-b border-gray-100 hover:bg-gray-50">
									<input
										type="checkbox"
										checked={selectedPOCs.includes(poc.id)}
										onchange={() => togglePOCSelection(poc.id)}
										class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
									/>
									<div class="flex-1">
										<div class="flex items-center gap-2">
											<span class="font-medium text-sm">{poc.name}</span>
											<Badge class="text-xs" variant="outline">{poc.category}</Badge>
											<Badge class="text-xs" variant="outline">{poc.severity}</Badge>
										</div>
										<p class="text-xs text-gray-600 mt-1 line-clamp-2">{poc.description}</p>
									</div>
								</div>
							{/each}
						</div>
					</div>

					<!-- 扫描配置 -->
					<div>
						<h3 class="text-lg font-medium text-gray-900 mb-3">扫描配置</h3>
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
							<div>
								<label for="scan-concurrency" class="block text-sm font-medium text-gray-700 mb-1">并发数</label>
								<input
									id="scan-concurrency"
									type="number"
									bind:value={formData.config.concurrency}
									min={1}
									max={100}
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>

							<div>
								<label for="scan-timeout" class="block text-sm font-medium text-gray-700 mb-1">超时时间(秒)</label>
								<input
									id="scan-timeout"
									type="number"
									bind:value={formData.config.timeout}
									min={1}
									max={300}
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>

							<div>
								<label for="scan-retry" class="block text-sm font-medium text-gray-700 mb-1">重试次数</label>
								<input
									id="scan-retry"
									type="number"
									bind:value={formData.config.retryCount}
									min={0}
									max={10}
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>

							<div>
								<label for="scan-rate" class="block text-sm font-medium text-gray-700 mb-1"
									>请求速率限制(每秒)</label
								>
								<input
									id="scan-rate"
									type="number"
									bind:value={formData.config.rateLimit}
									min={1}
									max={100}
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>

							<div>
								<label for="scan-depth" class="block text-sm font-medium text-gray-700 mb-1">扫描深度</label>
								<input
									id="scan-depth"
									type="number"
									bind:value={formData.config.scanDepth}
									min={1}
									max={10}
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>

							<div>
								<label for="proxy-settings" class="block text-sm font-medium text-gray-700 mb-1">代理设置</label>
								<input
									id="proxy-settings"
									type="text"
									bind:value={formData.config.proxy}
									placeholder="http://proxy:8080"
									class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								/>
							</div>
						</div>

						<!-- 选项配置 -->
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
							<label class="flex items-center">
								<input
									type="checkbox"
									bind:checked={formData.config.followRedirect}
									class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"
								/>
								<span class="text-sm">跟随重定向</span>
							</label>

							<label class="flex items-center">
								<input
									type="checkbox"
									bind:checked={formData.config.saveToDB}
									class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"
								/>
								<span class="text-sm">保存到数据库</span>
							</label>

							<label class="flex items-center">
								<input
									type="checkbox"
									bind:checked={formData.config.verifyVuln}
									class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"
								/>
								<span class="text-sm">验证漏洞</span>
							</label>
						</div>
					</div>

					<!-- 高级配置 -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="custom-headers" class="block text-sm font-medium text-gray-700 mb-1">自定义请求头</label>
							<textarea
								id="custom-headers"
								bind:value={customHeadersInput}
								rows={4}
								placeholder="User-Agent: Custom-Agent
Authorization: Bearer token
X-Custom-Header: value"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							></textarea>
							<p class="text-xs text-gray-500 mt-1">格式：Header-Name: Header-Value</p>
						</div>

						<div>
							<label for="cookie-settings" class="block text-sm font-medium text-gray-700 mb-1">Cookie</label>
							<textarea
								id="cookie-settings"
								bind:value={formData.config.cookies}
								rows={2}
								placeholder="sessionid=value; token=value"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							></textarea>

							<label for="task-tags" class="block text-sm font-medium text-gray-700 mb-1 mt-3">任务标签</label>
							<input
								id="task-tags"
								type="text"
								bind:value={tagsInput}
								placeholder="用逗号分隔标签..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							/>
						</div>
					</div>

					<!-- 操作按钮 -->
					<div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
						<Button variant="outline" onclick={cancel} disabled={isSaving}>取消</Button>
						<Button onclick={save} disabled={isSaving || selectedPOCs.length === 0}>
							{isSaving ? '保存中...' : '创建任务'}
						</Button>
					</div>
				</CardContent>
			</Card>
		</div>
	</div>
{/if}

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
