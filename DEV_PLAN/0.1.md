# 版本 0.1 开发计划（修正版）：认证基础

## 版本目标
- 完善并兼容原项目ScopeSentry的认证体系，完成用户模型、JWT认证、登录/登出/用户信息API、前端登录页、认证状态管理等基础认证功能，确保接口、加密、索引、状态管理等关键点与原项目一致或更优。

---

## 任务Checklist

### TASK001 用户模型与数据库
- 版本：0.1
- 状态：已完成
- 子任务：
  - ✅ 设计User数据模型，字段包括：用户名、邮箱、哈希密码（bcrypt或SHA256）、角色、创建时间等，类型需兼容MongoDB。
  - ✅ 在MongoDB中实现用户集合，并为用户名、邮箱创建唯一索引。
  - ✅ 实现用户Repository，封装用户的增查改查操作，所有数据库操作必须通过该层。
- 验收标准：
  - User模型字段完整，类型正确，包含邮箱。
  - 密码加密算法为bcrypt或SHA256。
  - MongoDB集合与用户名、邮箱唯一索引创建无误。
  - Repository接口清晰，单元测试覆盖常用操作。
- 注意事项：
  - 密码加密存储，禁止明文。
  - 用户名/邮箱唯一索引。
  - 禁止在业务逻辑中直接操作数据库。

---

### TASK002 JWT生成与校验
- 版本：0.1
- 状态：已完成
- 子任务：
  - ✅ 新建internal/utils/jwt.go，集成golang-jwt/jwt/v4库，配置JWT密钥与过期时间，所有配置项从config.yaml读取，禁止硬编码。
  - ✅ 实现JWT生成函数，包含用户ID、角色、过期时间等必要信息。
  - ✅ 实现JWT校验与解析函数，支持中间件调用，返回统一错误。
  - ✅ 编写单元测试覆盖正常与异常场景。
- 验收标准：
  - JWT生成与校验函数通过单元测试。
  - 密钥与配置可热更新。
  - 错误处理统一，符合项目规范。
- 注意事项：
  - 禁止硬编码密钥。
  - 过期时间合理，支持刷新。

---

### TASK003 认证API接口
- 版本：0.1
- 状态：已完成
- 子任务：
  - ✅ 实现POST /api/v1/auth/login接口，支持用户名/邮箱+密码登录，返回JWT和用户信息，接口路径、参数、返回结构与原项目兼容。
  - ✅ 实现POST /api/v1/auth/logout接口，支持前端登出（如需黑名单机制）。
  - ✅ 实现GET /api/v1/auth/me接口，返回当前用户信息，接口命名与原项目保持一致。
  - ✅ 接口响应结构兼容原项目，统一错误处理。
  - ✅ 补充/完善接口单元测试。
- 验收标准：
  - API接口功能完整，参数校验严格。
  - 响应结构与原项目兼容。
  - 单元测试覆盖所有分支。
- 注意事项：
  - 登录失败返回明确错误码。
  - 禁止泄露敏感信息。

---

### TASK004 JWT中间件与路由保护
- 版本：0.1
- 状态：已完成
- 子任务：
  - ✅ 在internal/api/middleware.go实现JWT认证中间件，校验token有效性，注入用户信息到context。
  - ✅ 在所有需认证的API路由上应用中间件，确保无遗漏。
  - ✅ 支持角色权限校验（可扩展）。
  - ✅ 单元测试覆盖token缺失、无效、过期等场景。
- 验收标准：
  - 中间件功能完整，性能无明显损耗。
  - 路由保护无遗漏。
  - 单元测试覆盖异常分支。
- 注意事项：
  - 认证失败需中断请求，返回401。
  - 角色校验可扩展。

---

### TASK005 前端认证API服务与登录/注册页面
- 版本：0.1
- 状态：✅ 已完成（部分待优化）
- 子任务：
  - ✅ 在web/src/lib/api/auth.ts中封装login、logout、me、register等API方法，所有方法与后端接口路径、参数、返回结构严格一致，复用唯一api实例。
  - ✅ 统一处理API错误，抛出自定义异常，类型定义与后端保持同步。
  - ✅ 在routes/(auth)/login/+page.svelte实现登录表单，使用Felte+Zod校验，表单提交时调用authApi.login。
  - ✅ 登录成功后，token存储到localStorage，调用authStore更新状态，认证状态持久化，页面刷新后自动恢复。
  - ✅ 登录失败时，友好提示错误信息。
  - ✅ 实现注册页面，表单校验，调用authApi.register，注册成功后自动登录或跳转登录页。
  - ✅ 完善后端register接口，参数校验、唯一性校验、密码加密、返回结构与前端register流程完全对接。
  - ✅ 禁止在store中直接调用API，所有API调用通过服务层。
  - ❓ UI需兼容移动端，编写Cypress端到端测试。
- 验收标准：
  - API方法参数与返回值类型明确，仅使用唯一api实例。
  - 登录/注册流程顺畅，状态管理与本地存储同步。
  - 错误提示清晰，端到端测试通过。
- 注意事项：
  - 禁止直接用fetch或新建axios实例。
  - 类型定义与后端保持同步。
  - 禁止在store中直接调用API。
  - UI需兼容移动端。

---

### TASK007 前端开发环境API代理配置
- 版本：0.1
- 状态：已完成
- 子任务：
  - ✅ 在 `web/vite.config.ts` 中配置 Vite 开发服务器的 `server.proxy`，将所有 `/api` 路径请求自动代理到 `http://localhost:8090`。
  - ✅ 启动前后端服务，验证前端开发环境下所有认证相关API请求（如登录、登出、用户信息获取）均能正常访问后端8090端口，无404或CORS错误。
  - ✅ 执行Cypress端到端测试，确保认证等功能在开发环境下全部通过。
  - ✅ 在 `web/README.md` 或 `DEV_PLAN/0.1.md` 中补充开发环境API代理配置与本地联调说明，包括如后端端口变更需同步修改代理配置的指引。
  - ✅ 检查并确保代理配置仅在开发环境生效，生产环境由Nginx等反向代理处理，且不影响原有 `fs.allow` 等配置。
- 验收标准：
  - 前端开发环境下，所有 `/api/v1` 请求均能正确转发到后端8090端口，认证等功能可正常联调。
  - 端到端测试全部通过，无API 404或CORS错误。
  - 文档说明清晰，开发者可一键启动并联调。
  - 代理配置仅在开发环境生效，生产环境无影响。
- 注意事项：
  - 代理配置仅在开发环境生效，生产环境由Nginx等反向代理处理。
  - 如后端端口变更，需同步修改Vite代理配置。
  - 保证原有 `fs.allow` 等配置不被覆盖。
  - 需与团队成员同步本地联调方法，避免环境不一致导致的对接问题。

---

### TASK008 认证相关文档与验收
- 版本：0.1
- 状态：✅ 已完成
- 子任务：
  - ✅ 编写README.md中认证模块说明，包含API、状态管理、交互流程、错误处理等。
  - ✅ 在DEV_PLAN.md中补充认证模块开发计划与验收标准。
  - ✅ 补充单元测试与端到端测试用例，确保自动化运行，并在文档中说明测试覆盖范围。
  - ✅ 文档需持续更新，保持与实现同步。
- 验收标准：
  - 文档结构清晰，内容详实。
  - 测试用例覆盖率高。
  - 文档需持续更新，保持与实现同步。
  - 测试用例需自动化运行。
- 注意事项：
  - 认证模块文档已完整添加到README.md，包含完整的API说明、状态管理、交互流程和错误处理
  - DEV_PLAN.md中已补充认证模块的详细开发状态和验收标准
  - 后端测试已大幅改进，添加了完整的JWT测试、中间件测试、角色权限测试等
  - 前端测试已完善，覆盖所有API方法、错误处理和状态管理
  - 端到端测试已存在并覆盖完整认证流程
  - Makefile中已添加完整的测试命令，支持自动化运行
  - 测试覆盖范围说明已添加到README.md中 