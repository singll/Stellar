<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		vulnerabilityList,
		vulnerabilityPagination,
		vulnerabilityFilters
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { SEVERITY_CONFIG, STATUS_CONFIG, TYPE_CONFIG } from '$lib/types/vulnerability';
	import type {
		Vulnerability,
		VulnerabilitySeverity,
		VulnerabilityStatus,
		VulnerabilityType
	} from '$lib/types/vulnerability';

	// 外部属性
	let {
		taskId = null,
		projectId = null,
		vulnerabilities: propsVulnerabilities = null, // 添加 vulnerabilities 属性
		showFilters = true,
		showActions = true
	} = $props();

	// 组件状态
	let isLoading = $state(false);
	let showDetailDialog = $state(false);
	let selectedVuln = $state<Vulnerability | null>(null);
	let selectedVulns = $state<string[]>([]);

	// 列表状态
	let vulnerabilities = $state<Vulnerability[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		projectId: projectId,
		severity: undefined as VulnerabilitySeverity | undefined,
		status: undefined as VulnerabilityStatus | undefined,
		type: undefined as VulnerabilityType | undefined,
		search: undefined as string | undefined
	});

	// 订阅 store 变化
	$effect(() => {
		// 如果通过 props 传入了 vulnerabilities，使用它而不是 store
		if (propsVulnerabilities) {
			vulnerabilities = propsVulnerabilities;
			return;
		}

		const unsubscribeVulns = vulnerabilityList.subscribe((value) => (vulnerabilities = value));
		const unsubscribePagination = vulnerabilityPagination.subscribe(
			(value) => (pagination = value)
		);
		const unsubscribeFilters = vulnerabilityFilters.subscribe((value) => {
			filters = { ...value, projectId: projectId };
		});

		return () => {
			unsubscribeVulns();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// 页面加载时获取数据
	onMount(() => {
		loadVulnerabilities();
	});

	// 当taskId变化时重新加载
	$effect(() => {
		if (taskId) {
			loadVulnerabilities();
		}
	});

	// 加载漏洞列表
	async function loadVulnerabilities() {
		isLoading = true;
		try {
			await vulnStore.loadVulnerabilities({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters,
				...(projectId && { projectId })
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '加载漏洞列表失败: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// 分页处理
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadVulnerabilities();
	}

	// 过滤处理
	function handleFilterChange() {
		pagination.page = 1;
		loadVulnerabilities();
	}

	// 搜索处理
	function handleSearch(event: Event) {
		const target = event.target as HTMLInputElement;
		filters.search = target.value || undefined;
		handleFilterChange();
	}

	// 查看漏洞详情
	function viewDetail(vuln: Vulnerability) {
		selectedVuln = vuln;
		showDetailDialog = true;
	}

	// 更新漏洞状态
	async function updateStatus(vuln: Vulnerability, status: VulnerabilityStatus) {
		const success = await vulnStore.updateVulnerabilityStatus(vuln.id, status);
		if (success) {
			loadVulnerabilities();
		}
	}

	// 批量操作
	function handleSelectAll(checked: boolean) {
		if (checked) {
			selectedVulns = vulnerabilities.map((v) => v.id);
		} else {
			selectedVulns = [];
		}
	}

	function toggleSelection(vulnId: string) {
		if (selectedVulns.includes(vulnId)) {
			selectedVulns = selectedVulns.filter((id) => id !== vulnId);
		} else {
			selectedVulns = [...selectedVulns, vulnId];
		}
	}

	// 批量更新状态
	async function batchUpdateStatus(status: VulnerabilityStatus) {
		if (selectedVulns.length === 0) {
			notifications.add({
				type: 'warning',
				message: '请先选择要更新的漏洞'
			});
			return;
		}

		// 这里应该调用批量更新API
		notifications.add({
			type: 'info',
			message: `批量更新 ${selectedVulns.length} 个漏洞状态为: ${STATUS_CONFIG[status].label}`
		});
		selectedVulns = [];
		loadVulnerabilities();
	}

	// 导出漏洞
	async function exportVulnerabilities(format: 'json' | 'csv' | 'pdf' | 'html') {
		try {
			// TODO: 实现导出API，目前先注释掉format参数
			await vulnStore.loadVulnerabilities({
				...filters
				// format - 当导出API实现后添加
			});

			// 临时处理，因为当前API没有返回code
			notifications.add({
				type: 'success',
				message: `导出${format.toUpperCase()}文件成功`
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '导出失败: ' + errorMessage
			});
		}
	}

	// 获取严重性样式
	function getSeverityClass(severity: VulnerabilitySeverity) {
		const config = SEVERITY_CONFIG[severity];
		return `${config.bgColor} ${config.textColor} ${config.borderColor}`;
	}

	// 获取状态样式
	function getStatusClass(status: VulnerabilityStatus) {
		const config = STATUS_CONFIG[status];
		return `${config.bgColor} ${config.textColor}`;
	}

	// 格式化日期
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN', {
			year: 'numeric',
			month: '2-digit',
			day: '2-digit',
			hour: '2-digit',
			minute: '2-digit'
		});
	}

	// 获取漏洞类型配置
	function getTypeConfig(type: VulnerabilityType) {
		return TYPE_CONFIG[type];
	}

	// 截断文本
	function truncateText(text: string, maxLength: number): string {
		if (text.length <= maxLength) return text;
		return text.substring(0, maxLength) + '...';
	}
</script>

<div class="space-y-6">
	<!-- 标题和操作栏 -->
	<div class="flex justify-between items-center">
		<div>
			<h2 class="text-2xl font-bold text-gray-900">漏洞列表</h2>
			<p class="text-gray-600 mt-1">
				共发现 {pagination.total} 个漏洞
				{#if selectedVulns.length > 0}
					<span class="ml-2 text-blue-600">已选择 {selectedVulns.length} 个</span>
				{/if}
			</p>
		</div>

		{#if showActions}
			<div class="flex gap-3">
				<!-- 批量操作 -->
				{#if selectedVulns.length > 0}
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('verified')}>
						标记为已验证
					</Button>
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('fixed')}>
						标记为已修复
					</Button>
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('ignored')}>
						标记为已忽略
					</Button>
				{/if}

				<!-- 导出 -->
				<div class="relative group">
					<Button size="sm" variant="outline">导出</Button>
					<div
						class="absolute right-0 top-full mt-1 w-32 bg-white border border-gray-200 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10"
					>
						<button
							onclick={() => exportVulnerabilities('json')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">JSON</button
						>
						<button
							onclick={() => exportVulnerabilities('csv')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">CSV</button
						>
						<button
							onclick={() => exportVulnerabilities('pdf')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">PDF</button
						>
						<button
							onclick={() => exportVulnerabilities('html')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">HTML</button
						>
					</div>
				</div>

				<Button
					size="sm"
					variant="outline"
					onclick={() => loadVulnerabilities()}
					disabled={isLoading}
				>
					{isLoading ? '刷新中...' : '刷新'}
				</Button>
			</div>
		{/if}
	</div>

	<!-- 过滤栏 -->
	{#if showFilters}
		<Card>
			<CardContent class="p-4">
				<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
					<!-- 搜索框 -->
					<div>
						<label for="vuln-search" class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
						<input
							id="vuln-search"
							type="text"
							value={filters.search || ''}
							onkeyup={handleSearch}
							placeholder="搜索漏洞标题或URL..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						/>
					</div>

					<!-- 严重性过滤 -->
					<div>
						<label for="vuln-severity-filter" class="block text-sm font-medium text-gray-700 mb-1">严重性</label>
						<select
							id="vuln-severity-filter"
							bind:value={filters.severity}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>全部严重性</option>
							<option value="critical">严重</option>
							<option value="high">高危</option>
							<option value="medium">中危</option>
							<option value="low">低危</option>
							<option value="info">信息</option>
						</select>
					</div>

					<!-- 状态过滤 -->
					<div>
						<label for="vulnerability-status-filter" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
						<select
							id="vulnerability-status-filter"
							bind:value={filters.status}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>全部状态</option>
							<option value="unverified">未验证</option>
							<option value="verified">已验证</option>
							<option value="fixed">已修复</option>
							<option value="false_positive">误报</option>
							<option value="ignored">已忽略</option>
						</select>
					</div>

					<!-- 类型过滤 -->
					<div>
						<label for="vulnerability-type-filter" class="block text-sm font-medium text-gray-700 mb-1">类型</label>
						<select
							id="vulnerability-type-filter"
							bind:value={filters.type}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>全部类型</option>
							<option value="web">Web漏洞</option>
							<option value="system">系统漏洞</option>
							<option value="network">网络漏洞</option>
							<option value="config">配置漏洞</option>
							<option value="component">组件漏洞</option>
						</select>
					</div>

					<!-- 统计信息 -->
					<div class="flex items-end">
						<div class="text-sm text-gray-600">
							显示 {vulnerabilities.length} / {pagination.total} 个结果
						</div>
					</div>
				</div>
			</CardContent>
		</Card>
	{/if}

	<!-- 漏洞列表 -->
	<div class="space-y-4">
		<!-- 全选复选框 -->
		{#if showActions && vulnerabilities.length > 0}
			<div class="flex items-center p-3 bg-gray-50 rounded-md">
				<input
					type="checkbox"
					checked={selectedVulns.length === vulnerabilities.length && vulnerabilities.length > 0}
					onchange={(e) => handleSelectAll((e.target as HTMLInputElement).checked)}
					class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
				/>
				<span class="text-sm text-gray-700">
					全选 ({selectedVulns.length}/{vulnerabilities.length})
				</span>
			</div>
		{/if}

		{#each vulnerabilities as vuln (vuln.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardContent class="p-6">
					<div class="flex items-start gap-4">
						<!-- 选择框 -->
						{#if showActions}
							<input
								type="checkbox"
								checked={selectedVulns.includes(vuln.id)}
								onchange={() => toggleSelection(vuln.id)}
								class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
							/>
						{/if}

						<!-- 漏洞信息 -->
						<div class="flex-1">
							<!-- 标题和标签 -->
							<div class="flex items-start justify-between mb-3">
								<div class="flex-1">
									<h3 class="text-lg font-semibold text-gray-900 mb-2">{vuln.title}</h3>
									<div class="flex flex-wrap gap-2">
										<Badge class={getSeverityClass(vuln.severity)}>
											{SEVERITY_CONFIG[vuln.severity].label}
										</Badge>
										<Badge class={getStatusClass(vuln.status)}>
											{STATUS_CONFIG[vuln.status].label}
										</Badge>
										<Badge variant="outline">
											{getTypeConfig(vuln.type).icon}
											{getTypeConfig(vuln.type).label}
										</Badge>
										{#if vuln.cveId}
											<Badge variant="outline">{vuln.cveId}</Badge>
										{/if}
										{#if vuln.cweId}
											<Badge variant="outline">{vuln.cweId}</Badge>
										{/if}
									</div>
								</div>

								<!-- 评分 -->
								<div class="text-right ml-4">
									<div class="text-2xl font-bold text-gray-900">{vuln.score}</div>
									<div class="text-xs text-gray-500">CVSS评分</div>
								</div>
							</div>

							<!-- 描述 -->
							<p class="text-gray-700 mb-3 line-clamp-2">{vuln.description}</p>

							<!-- 详细信息 -->
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
								<div>
									<div class="text-sm text-gray-500 mb-1">影响目标</div>
									<div class="text-sm">
										<div>
											URL: <span class="font-mono text-blue-600"
												>{truncateText(vuln.affectedUrl, 50)}</span
											>
										</div>
										<div>Host: {vuln.affectedHost}</div>
										{#if vuln.affectedPort}
											<div>Port: {vuln.affectedPort}</div>
										{/if}
										{#if vuln.affectedParam}
											<div>参数: {vuln.affectedParam}</div>
										{/if}
									</div>
								</div>

								<div>
									<div class="text-sm text-gray-500 mb-1">检测信息</div>
									<div class="text-sm">
										<div>POC: {vuln.pocName}</div>
										<div>发现时间: {formatDate(vuln.discoveredAt)}</div>
										{#if vuln.verifiedAt}
											<div>验证时间: {formatDate(vuln.verifiedAt)}</div>
										{/if}
										{#if vuln.fixedAt}
											<div>修复时间: {formatDate(vuln.fixedAt)}</div>
										{/if}
									</div>
								</div>
							</div>

							<!-- Payload预览 -->
							{#if vuln.payload}
								<div class="mb-3">
									<div class="text-sm text-gray-500 mb-1">Payload</div>
									<div class="bg-gray-50 p-2 rounded text-sm font-mono text-gray-800 truncate">
										{truncateText(vuln.payload, 100)}
									</div>
								</div>
							{/if}

							<!-- 标签 -->
							{#if vuln.tags && vuln.tags.length > 0}
								<div class="flex flex-wrap gap-1 mb-3">
									{#each vuln.tags.slice(0, 5) as tag}
										<Badge variant="outline" class="text-xs">{tag}</Badge>
									{/each}
									{#if vuln.tags.length > 5}
										<Badge variant="outline" class="text-xs">+{vuln.tags.length - 5}</Badge>
									{/if}
								</div>
							{/if}
						</div>

						<!-- 操作按钮 -->
						{#if showActions}
							<div class="flex flex-col gap-2">
								<Button size="sm" onclick={() => viewDetail(vuln)}>查看详情</Button>

								{#if vuln.status === 'unverified'}
									<Button
										size="sm"
										variant="outline"
										onclick={() => updateStatus(vuln, 'verified')}
									>
										验证
									</Button>
								{:else if vuln.status === 'verified'}
									<Button size="sm" variant="outline" onclick={() => updateStatus(vuln, 'fixed')}>
										标记修复
									</Button>
								{/if}

								<Button size="sm" variant="outline" onclick={() => updateStatus(vuln, 'ignored')}>
									忽略
								</Button>
							</div>
						{/if}
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- 空状态 -->
	{#if !isLoading && vulnerabilities.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">🔒</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">暂无漏洞</h3>
			<p class="text-gray-500">{taskId ? '此次扫描未发现漏洞' : '还没有发现任何漏洞'}</p>
		</div>
	{/if}

	<!-- 分页 -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					上一页
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					第 {pagination.page} 页，共 {pagination.totalPages} 页
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					下一页
				</Button>
			</div>
		</div>
	{/if}

	<!-- 加载状态 -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">加载中...</p>
			</div>
		</div>
	{/if}
</div>

<!-- 漏洞详情对话框 -->
{#if showDetailDialog && selectedVuln}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
		<div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
			<Card>
				<CardHeader>
					<div class="flex justify-between items-start">
						<CardTitle>漏洞详情</CardTitle>
						<Button variant="outline" size="sm" onclick={() => (showDetailDialog = false)}>
							关闭
						</Button>
					</div>
				</CardHeader>

				<CardContent class="space-y-6">
					<!-- 基本信息 -->
					<div>
						<h3 class="text-lg font-semibold mb-3">{selectedVuln.title}</h3>
						<div class="flex flex-wrap gap-2 mb-4">
							<Badge class={getSeverityClass(selectedVuln.severity)}>
								{SEVERITY_CONFIG[selectedVuln.severity].label}
							</Badge>
							<Badge class={getStatusClass(selectedVuln.status)}>
								{STATUS_CONFIG[selectedVuln.status].label}
							</Badge>
							<Badge variant="outline">
								{getTypeConfig(selectedVuln.type).label}
							</Badge>
							{#if selectedVuln.cveId}
								<Badge variant="outline">{selectedVuln.cveId}</Badge>
							{/if}
							{#if selectedVuln.cweId}
								<Badge variant="outline">{selectedVuln.cweId}</Badge>
							{/if}
						</div>
						<p class="text-gray-700">{selectedVuln.description}</p>
					</div>

					<!-- 影响信息 -->
					<div>
						<h4 class="font-semibold mb-2">影响信息</h4>
						<div class="bg-gray-50 p-4 rounded">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<div class="text-sm font-medium text-gray-700">URL</div>
									<div class="font-mono text-sm break-all">{selectedVuln.affectedUrl}</div>
								</div>
								<div>
									<div class="text-sm font-medium text-gray-700">主机</div>
									<div class="text-sm">{selectedVuln.affectedHost}</div>
								</div>
								{#if selectedVuln.affectedPort}
									<div>
										<div class="text-sm font-medium text-gray-700">端口</div>
										<div class="text-sm">{selectedVuln.affectedPort}</div>
									</div>
								{/if}
								{#if selectedVuln.affectedParam}
									<div>
										<div class="text-sm font-medium text-gray-700">参数</div>
										<div class="text-sm">{selectedVuln.affectedParam}</div>
									</div>
								{/if}
							</div>
						</div>
					</div>

					<!-- 技术细节 -->
					<div>
						<h4 class="font-semibold mb-2">技术细节</h4>
						<div class="space-y-4">
							{#if selectedVuln.payload}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">Payload</div>
									<pre
										class="bg-gray-900 text-green-400 p-3 rounded text-sm overflow-x-auto">{selectedVuln.payload}</pre>
								</div>
							{/if}

							{#if selectedVuln.request}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">请求</div>
									<pre
										class="bg-gray-50 p-3 rounded text-sm overflow-x-auto border">{selectedVuln.request}</pre>
								</div>
							{/if}

							{#if selectedVuln.response}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">响应</div>
									<pre
										class="bg-gray-50 p-3 rounded text-sm overflow-x-auto border max-h-60">{selectedVuln.response}</pre>
								</div>
							{/if}
						</div>
					</div>

					<!-- 修复建议 -->
					{#if selectedVuln.solution}
						<div>
							<h4 class="font-semibold mb-2">修复建议</h4>
							<div class="bg-blue-50 border border-blue-200 p-4 rounded">
								<p class="text-blue-800">{selectedVuln.solution}</p>
							</div>
						</div>
					{/if}

					<!-- 参考链接 -->
					{#if selectedVuln.references && selectedVuln.references.length > 0}
						<div>
							<h4 class="font-semibold mb-2">参考链接</h4>
							<ul class="list-disc list-inside space-y-1">
								{#each selectedVuln.references as ref}
									<li>
										<a href={ref} target="_blank" class="text-blue-600 hover:underline">{ref}</a>
									</li>
								{/each}
							</ul>
						</div>
					{/if}

					<!-- 时间信息 -->
					<div>
						<h4 class="font-semibold mb-2">时间信息</h4>
						<div class="text-sm text-gray-600 space-y-1">
							<div>发现时间: {formatDate(selectedVuln.discoveredAt)}</div>
							{#if selectedVuln.verifiedAt}
								<div>验证时间: {formatDate(selectedVuln.verifiedAt)}</div>
							{/if}
							{#if selectedVuln.fixedAt}
								<div>修复时间: {formatDate(selectedVuln.fixedAt)}</div>
							{/if}
							<div>创建时间: {formatDate(selectedVuln.createdAt)}</div>
							<div>更新时间: {formatDate(selectedVuln.updatedAt)}</div>
						</div>
					</div>
				</CardContent>
			</Card>
		</div>
	</div>
{/if}

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
