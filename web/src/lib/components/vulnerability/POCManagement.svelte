<script lang="ts">
	import { onMount } from 'svelte';
	import { goto } from '$app/navigation';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		pocList,
		pocPagination,
		pocFilters,
		selectedPOC
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { SEVERITY_CONFIG, TYPE_CONFIG } from '$lib/types/vulnerability';
	import type { POC, VulnerabilitySeverity, VulnerabilityType } from '$lib/types/vulnerability';

	// 外部回调属性
	let { onCreatePOC = () => {}, onEditPOC = () => {} } = $props();

	// 组件状态
	let isLoading = $state(false);
	let showCreateDialog = $state(false);
	let showEditDialog = $state(false);
	let showDeleteDialog = $state(false);
	let currentPOC = $state<POC | null>(null);

	// 列表状态
	let pocs = $state<POC[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		type: undefined as VulnerabilityType | undefined,
		category: undefined as string | undefined,
		severity: undefined as VulnerabilitySeverity | undefined,
		enabled: undefined as boolean | undefined,
		search: undefined as string | undefined
	});

	// 订阅 store 变化
	$effect(() => {
		const unsubscribePOCs = pocList.subscribe((value) => (pocs = value));
		const unsubscribePagination = pocPagination.subscribe((value) => (pagination = value));
		const unsubscribeFilters = pocFilters.subscribe((value) => (filters = value));

		return () => {
			unsubscribePOCs();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// 页面加载时获取数据
	onMount(() => {
		loadPOCs();
	});

	// 加载POC列表
	async function loadPOCs() {
		isLoading = true;
		try {
			await vulnStore.loadPOCs({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '加载POC列表失败: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// 分页处理
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadPOCs();
	}

	// 过滤处理
	function handleFilterChange() {
		pagination.page = 1;
		loadPOCs();
	}

	// 搜索处理
	function handleSearch(event: Event) {
		const target = event.target as HTMLInputElement;
		filters.search = target.value || undefined;
		handleFilterChange();
	}

	// 编辑POC
	function editPOC(poc: POC) {
		onEditPOC(poc);
	}

	// 删除POC
	function deletePOC(poc: POC) {
		currentPOC = poc;
		showDeleteDialog = true;
	}

	// 确认删除POC
	async function confirmDelete() {
		if (!currentPOC) return;

		const success = await vulnStore.deletePOC(currentPOC.id);
		if (success) {
			showDeleteDialog = false;
			currentPOC = null;
			loadPOCs();
		}
	}

	// 切换POC启用状态
	async function togglePOCEnabled(poc: POC) {
		const success = await vulnStore.updatePOC(poc.id, {
			enabled: !poc.enabled
		});
		if (success) {
			loadPOCs();
		}
	}

	// 测试POC
	async function testPOC(poc: POC) {
		const target = prompt('请输入测试目标URL:', 'http://example.com');
		if (!target) return;

		const result = await vulnStore.testPOC(poc.id, target);
		if (result) {
			notifications.add({
				type: result.success ? 'success' : 'info',
				message: `POC测试${result.success ? '成功' : '失败'}: ${result.output || result.error}`
			});
		}
	}

	// 获取严重性样式
	function getSeverityClass(severity: VulnerabilitySeverity) {
		const config = SEVERITY_CONFIG[severity];
		return `${config.bgColor} ${config.textColor} ${config.borderColor}`;
	}

	// 获取类型配置
	function getTypeConfig(type: VulnerabilityType) {
		return TYPE_CONFIG[type];
	}

	// 格式化日期
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN');
	}
</script>

<div class="container mx-auto p-6">
	<!-- 页面标题和操作栏 -->
	<div class="flex justify-between items-center mb-6">
		<div>
			<h1 class="text-3xl font-bold text-gray-900">POC管理</h1>
			<p class="text-gray-600 mt-1">管理漏洞检测POC脚本</p>
		</div>
		<div class="flex gap-3">
			<Button onclick={() => loadPOCs()} variant="outline" disabled={isLoading}>
				{isLoading ? '刷新中...' : '刷新'}
			</Button>
			<Button onclick={() => onCreatePOC()}>创建POC</Button>
		</div>
	</div>

	<!-- 过滤和搜索栏 -->
	<Card class="mb-6">
		<CardContent class="p-4">
			<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
				<!-- 搜索框 -->
				<div>
					<label for="poc-search" class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
					<input
						id="poc-search"
						type="text"
						value={filters.search || ''}
						onkeyup={handleSearch}
						placeholder="搜索POC名称或描述..."
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<!-- 类型过滤 -->
				<div>
					<label for="poc-type-filter" class="block text-sm font-medium text-gray-700 mb-1">类型</label>
					<select
						id="poc-type-filter"
						bind:value={filters.type}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>全部类型</option>
						<option value="web">Web漏洞</option>
						<option value="system">系统漏洞</option>
						<option value="network">网络漏洞</option>
						<option value="config">配置漏洞</option>
						<option value="component">组件漏洞</option>
					</select>
				</div>

				<!-- 严重性过滤 -->
				<div>
					<label for="poc-severity-filter" class="block text-sm font-medium text-gray-700 mb-1">严重性</label>
					<select
						id="poc-severity-filter"
						bind:value={filters.severity}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>全部严重性</option>
						<option value="critical">严重</option>
						<option value="high">高危</option>
						<option value="medium">中危</option>
						<option value="low">低危</option>
						<option value="info">信息</option>
					</select>
				</div>

				<!-- 状态过滤 -->
				<div>
					<label for="poc-status-filter" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
					<select
						id="poc-status-filter"
						bind:value={filters.enabled}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>全部状态</option>
						<option value={true}>已启用</option>
						<option value={false}>已禁用</option>
					</select>
				</div>

				<!-- 分类过滤 -->
				<div>
					<label for="poc-category-filter" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
					<input
						id="poc-category-filter"
						type="text"
						bind:value={filters.category}
						onchange={handleFilterChange}
						placeholder="输入分类名称..."
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- POC列表 -->
	<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
		{#each pocs as poc (poc.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardHeader class="pb-3">
					<div class="flex justify-between items-start">
						<CardTitle class="text-lg font-semibold text-gray-900 truncate">
							{poc.name}
						</CardTitle>
						<div class="flex gap-2 ml-2">
							<Badge class={getSeverityClass(poc.severity)}>
								{SEVERITY_CONFIG[poc.severity].label}
							</Badge>
							<Badge variant={poc.enabled ? 'default' : 'secondary'}>
								{poc.enabled ? '启用' : '禁用'}
							</Badge>
						</div>
					</div>
				</CardHeader>

				<CardContent>
					<div class="space-y-3">
						<!-- 基本信息 -->
						<div>
							<p class="text-sm text-gray-600 line-clamp-2">{poc.description}</p>
						</div>

						<!-- 详细信息 -->
						<div class="grid grid-cols-2 gap-2 text-xs text-gray-500">
							<div>
								<span class="font-medium">类型:</span>
								<span class="ml-1">{getTypeConfig(poc.type).label}</span>
							</div>
							<div>
								<span class="font-medium">分类:</span>
								<span class="ml-1">{poc.category}</span>
							</div>
							<div>
								<span class="font-medium">作者:</span>
								<span class="ml-1">{poc.author}</span>
							</div>
							<div>
								<span class="font-medium">脚本:</span>
								<span class="ml-1">{poc.scriptType.toUpperCase()}</span>
							</div>
						</div>

						<!-- CVE/CWE信息 -->
						{#if poc.cveId || poc.cweId}
							<div class="flex gap-2">
								{#if poc.cveId}
									<Badge variant="outline" class="text-xs">{poc.cveId}</Badge>
								{/if}
								{#if poc.cweId}
									<Badge variant="outline" class="text-xs">{poc.cweId}</Badge>
								{/if}
							</div>
						{/if}

						<!-- 统计信息 -->
						{#if poc.runCount > 0}
							<div class="text-xs text-gray-500">
								<span>执行次数: {poc.runCount}</span>
								<span class="mx-2">|</span>
								<span>成功率: {(poc.successRate * 100).toFixed(1)}%</span>
							</div>
						{/if}

						<!-- 标签 -->
						{#if poc.tags && poc.tags.length > 0}
							<div class="flex flex-wrap gap-1">
								{#each poc.tags.slice(0, 3) as tag}
									<Badge variant="outline" class="text-xs">{tag}</Badge>
								{/each}
								{#if poc.tags.length > 3}
									<Badge variant="outline" class="text-xs">+{poc.tags.length - 3}</Badge>
								{/if}
							</div>
						{/if}

						<!-- 操作按钮 -->
						<div class="flex justify-between items-center pt-2 border-t border-gray-100">
							<div class="flex gap-2">
								<Button size="sm" variant="outline" onclick={() => testPOC(poc)}>测试</Button>
								<Button size="sm" variant="outline" onclick={() => editPOC(poc)}>编辑</Button>
							</div>
							<div class="flex gap-2">
								<Button
									size="sm"
									variant={poc.enabled ? 'outline' : 'default'}
									onclick={() => togglePOCEnabled(poc)}
								>
									{poc.enabled ? '禁用' : '启用'}
								</Button>
								<Button size="sm" variant="destructive" onclick={() => deletePOC(poc)}>删除</Button>
							</div>
						</div>

						<!-- 时间信息 -->
						<div class="text-xs text-gray-400 pt-1">
							创建于: {formatDate(poc.createdAt)}
							{#if poc.updatedAt !== poc.createdAt}
								<span class="mx-2">|</span>
								更新于: {formatDate(poc.updatedAt)}
							{/if}
						</div>
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- 空状态 -->
	{#if !isLoading && pocs.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">📋</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">暂无POC</h3>
			<p class="text-gray-500 mb-4">还没有创建任何POC脚本</p>
			<Button onclick={() => onCreatePOC()}>创建第一个POC</Button>
		</div>
	{/if}

	<!-- 分页 -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center mt-8">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					上一页
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					第 {pagination.page} 页，共 {pagination.totalPages} 页
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					下一页
				</Button>
			</div>
		</div>
	{/if}

	<!-- 加载状态 -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">加载中...</p>
			</div>
		</div>
	{/if}
</div>

<!-- 删除确认对话框 -->
{#if showDeleteDialog && currentPOC}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
			<h3 class="text-lg font-semibold text-gray-900 mb-2">确认删除</h3>
			<p class="text-gray-600 mb-4">
				确定要删除POC "{currentPOC.name}" 吗？此操作不可恢复。
			</p>
			<div class="flex justify-end gap-3">
				<Button variant="outline" onclick={() => (showDeleteDialog = false)}>取消</Button>
				<Button variant="destructive" onclick={confirmDelete}>确认删除</Button>
			</div>
		</div>
	</div>
{/if}

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
