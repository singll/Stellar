<script lang="ts">
	import { onMount } from 'svelte';
	import VulnScanTaskList from '$lib/components/vulnerability/VulnScanTaskList.svelte';
	import VulnScanTaskDialog from '$lib/components/vulnerability/VulnScanTaskDialog.svelte';
	import { vulnStore, selectedScanTask } from '$lib/stores/vulnerability';
	import { goto } from '$app/navigation';
	import type { VulnScanTask } from '$lib/types/vulnerability';

	// 组件状态
	let showCreateDialog = $state(false);
	let showEditDialog = $state(false);
	let currentTask = $state<VulnScanTask | null>(null);

	// 监听选中的任务变化
	$effect(() => {
		const unsubscribe = selectedScanTask.subscribe((task) => {
			currentTask = task;
		});
		return unsubscribe;
	});

	// 创建任务
	function createTask() {
		currentTask = null;
		vulnStore.selectScanTask(null);
		showCreateDialog = true;
	}

	// 编辑任务
	function editTask(task: VulnScanTask) {
		currentTask = task;
		vulnStore.selectScanTask(task);
		showEditDialog = true;
	}

	// 删除任务
	async function deleteTask(taskId: string) {
		if (confirm('确定要删除这个扫描任务吗？')) {
			await vulnStore.deleteScanTask(taskId);
		}
	}

	// 启动任务
	async function startTask(taskId: string) {
		await vulnStore.startScanTask(taskId);
	}

	// 停止任务
	async function stopTask(taskId: string) {
		await vulnStore.stopScanTask(taskId);
	}

	// 查看结果
	function viewResults(taskId: string) {
		goto(`/vulnerability/results/${taskId}`);
	}

	// 页面加载时初始化数据
	onMount(() => {
		vulnStore.loadScanTasks();
	});
</script>

<div class="container mx-auto px-4 py-6">
	<!-- 页面标题 -->
	<div class="mb-6">
		<div class="flex items-center justify-between">
			<div>
				<h1 class="text-2xl font-bold text-gray-900">漏洞扫描任务</h1>
				<p class="text-gray-600 mt-1">管理和执行漏洞扫描任务</p>
			</div>
			<button
				onclick={createTask}
				class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium"
			>
				新建任务
			</button>
		</div>
	</div>

	<!-- 任务列表 -->
	<VulnScanTaskList
		onEdit={editTask}
		onDelete={deleteTask}
		onStart={startTask}
		onStop={stopTask}
		onViewResults={viewResults}
	/>

	<!-- 创建任务对话框 -->
	{#if showCreateDialog}
		<VulnScanTaskDialog
			bind:open={showCreateDialog}
			task={null}
			onSave={() => {
				showCreateDialog = false;
				vulnStore.loadScanTasks();
			}}
			onCancel={() => (showCreateDialog = false)}
		/>
	{/if}

	<!-- 编辑任务对话框 -->
	{#if showEditDialog && currentTask}
		<VulnScanTaskDialog
			bind:open={showEditDialog}
			task={currentTask}
			onSave={() => {
				showEditDialog = false;
				vulnStore.loadScanTasks();
			}}
			onCancel={() => (showEditDialog = false)}
		/>
	{/if}
</div>
