<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import { vulnStore } from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import type {
		POC,
		VulnerabilitySeverity,
		VulnerabilityType,
		POCScriptType
	} from '$lib/types/vulnerability';

	let { poc = null, isOpen = $bindable(false), onSave = () => {}, onCancel = () => {} } = $props();

	// 表单数据
	let formData = $state({
		name: '',
		description: '',
		author: '',
		references: [] as string[],
		cveId: '',
		cweId: '',
		severity: 'medium' as VulnerabilitySeverity,
		type: 'web' as VulnerabilityType,
		category: '',
		script: '',
		scriptType: 'yaml' as POCScriptType,
		tags: [] as string[],
		requiredParams: [] as string[],
		defaultParams: {} as Record<string, string>,
		enabled: true
	});

	// 验证状态
	let validationResult = $state<{ valid: boolean; errors: string[] } | null>(null);
	let isValidating = $state(false);
	let isSaving = $state(false);

	// 表单验证错误
	let errors = $state({
		name: '',
		description: '',
		script: '',
		category: ''
	});

	// 文本输入辅助状态
	let referencesInput = $state('');
	let tagsInput = $state('');
	let requiredParamsInput = $state('');
	let defaultParamsInput = $state('');

	// 当 poc 属性变化时，更新表单数据
	$effect(() => {
		if (poc) {
			formData = {
				name: poc.name,
				description: poc.description,
				author: poc.author,
				references: [...poc.references],
				cveId: poc.cveId,
				cweId: poc.cweId,
				severity: poc.severity,
				type: poc.type,
				category: poc.category,
				script: poc.script,
				scriptType: poc.scriptType,
				tags: [...poc.tags],
				requiredParams: [...poc.requiredParams],
				defaultParams: { ...poc.defaultParams },
				enabled: poc.enabled
			};

			// 更新输入框
			referencesInput = poc.references.join('\n');
			tagsInput = poc.tags.join(', ');
			requiredParamsInput = poc.requiredParams.join(', ');
			defaultParamsInput = Object.entries(poc.defaultParams)
				.map(([k, v]) => `${k}=${v}`)
				.join('\n');
		} else {
			resetForm();
		}
	});

	// 重置表单
	function resetForm() {
		formData = {
			name: '',
			description: '',
			author: '',
			references: [],
			cveId: '',
			cweId: '',
			severity: 'medium',
			type: 'web',
			category: '',
			script: '',
			scriptType: 'yaml',
			tags: [],
			requiredParams: [],
			defaultParams: {},
			enabled: true
		};

		referencesInput = '';
		tagsInput = '';
		requiredParamsInput = '';
		defaultParamsInput = '';

		errors = {
			name: '',
			description: '',
			script: '',
			category: ''
		};

		validationResult = null;
	}

	// 验证表单
	function validateForm(): boolean {
		errors = {
			name: '',
			description: '',
			script: '',
			category: ''
		};

		let isValid = true;

		if (!formData.name.trim()) {
			errors.name = 'POC名称不能为空';
			isValid = false;
		}

		if (!formData.description.trim()) {
			errors.description = '描述不能为空';
			isValid = false;
		}

		if (!formData.script.trim()) {
			errors.script = '脚本内容不能为空';
			isValid = false;
		}

		if (!formData.category.trim()) {
			errors.category = '分类不能为空';
			isValid = false;
		}

		return isValid;
	}

	// 解析输入数据
	function parseInputs() {
		// 解析references
		formData.references = referencesInput
			.split('\n')
			.map((s) => s.trim())
			.filter((s) => s.length > 0);

		// 解析tags
		formData.tags = tagsInput
			.split(',')
			.map((s) => s.trim())
			.filter((s) => s.length > 0);

		// 解析requiredParams
		formData.requiredParams = requiredParamsInput
			.split(',')
			.map((s) => s.trim())
			.filter((s) => s.length > 0);

		// 解析defaultParams
		formData.defaultParams = {};
		defaultParamsInput
			.split('\n')
			.map((s) => s.trim())
			.filter((s) => s.length > 0)
			.forEach((line) => {
				const [key, ...values] = line.split('=');
				if (key && values.length > 0) {
					formData.defaultParams[key.trim()] = values.join('=').trim();
				}
			});
	}

	// 验证脚本
	async function validateScript() {
		if (!formData.script.trim()) {
			validationResult = { valid: false, errors: ['脚本内容不能为空'] };
			return;
		}

		isValidating = true;
		validationResult = null;

		try {
			const result = await vulnStore.validatePOC(formData.script, formData.scriptType);
			validationResult = result;

			if (result?.valid) {
				notifications.add({
					type: 'success',
					message: 'POC脚本验证通过'
				});
			} else {
				notifications.add({
					type: 'error',
					message: 'POC脚本验证失败'
				});
			}
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			validationResult = { valid: false, errors: ['验证失败: ' + errorMessage] };
		} finally {
			isValidating = false;
		}
	}

	// 保存POC
	async function save() {
		if (!validateForm()) {
			return;
		}

		parseInputs();

		isSaving = true;

		try {
			let result;
			if (poc) {
				// 更新现有POC
				result = await vulnStore.updatePOC(poc.id, formData);
			} else {
				// 创建新POC
				result = await vulnStore.createPOC(formData);
			}

			if (result) {
				onSave(result);
				isOpen = false;
				resetForm();
			}
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: '保存失败: ' + errorMessage
			});
		} finally {
			isSaving = false;
		}
	}

	// 取消操作
	function cancel() {
		onCancel();
		isOpen = false;
		resetForm();
	}

	// YAML模板
	const yamlTemplate = `info:
  name: "示例POC"
  author: "示例作者"
  severity: medium
  description: "POC描述"
  reference:
    - https://example.com

requests:
  - method: GET
    path: "/"
    headers:
      User-Agent: "StellarScan/1.0"
    matchers:
      - type: status
        status:
          - 200
      - type: word
        words:
          - "Expected Response"
        part: body
        condition: and`;

	// 插入模板
	function insertTemplate() {
		if (formData.scriptType === 'yaml') {
			formData.script = yamlTemplate;
		}
	}
</script>

{#if isOpen}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
		<div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
			<Card>
				<CardHeader>
					<CardTitle>
						{poc ? '编辑POC' : '创建POC'}
					</CardTitle>
				</CardHeader>

				<CardContent class="space-y-6">
					<!-- 基本信息 -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="poc-name" class="block text-sm font-medium text-gray-700 mb-1">
								POC名称 <span class="text-red-500">*</span>
							</label>
							<input
								id="poc-name"
								type="text"
								bind:value={formData.name}
								placeholder="输入POC名称..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								class:border-red-500={errors.name}
							/>
							{#if errors.name}
								<p class="text-red-500 text-xs mt-1">{errors.name}</p>
							{/if}
						</div>

						<div>
							<label for="poc-author" class="block text-sm font-medium text-gray-700 mb-1">作者</label>
							<input
								id="poc-author"
								type="text"
								bind:value={formData.author}
								placeholder="输入作者名称..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							/>
						</div>

						<div>
							<label for="poc-category" class="block text-sm font-medium text-gray-700 mb-1">
								分类 <span class="text-red-500">*</span>
							</label>
							<input
								id="poc-category"
								type="text"
								bind:value={formData.category}
								placeholder="输入分类名称..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
								class:border-red-500={errors.category}
							/>
							{#if errors.category}
								<p class="text-red-500 text-xs mt-1">{errors.category}</p>
							{/if}
						</div>

						<div>
							<label for="poc-status" class="block text-sm font-medium text-gray-700 mb-1">状态</label>
							<select
								id="poc-status"
								bind:value={formData.enabled}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							>
								<option value={true}>启用</option>
								<option value={false}>禁用</option>
							</select>
						</div>

						<div>
							<label for="poc-type" class="block text-sm font-medium text-gray-700 mb-1">漏洞类型</label>
							<select
								id="poc-type"
								bind:value={formData.type}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							>
								<option value="web">Web漏洞</option>
								<option value="system">系统漏洞</option>
								<option value="network">网络漏洞</option>
								<option value="config">配置漏洞</option>
								<option value="component">组件漏洞</option>
							</select>
						</div>

						<div>
							<label for="poc-severity" class="block text-sm font-medium text-gray-700 mb-1">严重性级别</label>
							<select
								id="poc-severity"
								bind:value={formData.severity}
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							>
								<option value="critical">严重</option>
								<option value="high">高危</option>
								<option value="medium">中危</option>
								<option value="low">低危</option>
								<option value="info">信息</option>
							</select>
						</div>

						<div>
							<label for="poc-cve" class="block text-sm font-medium text-gray-700 mb-1">CVE ID</label>
							<input
								id="poc-cve"
								type="text"
								bind:value={formData.cveId}
								placeholder="如: CVE-2023-1234"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							/>
						</div>

						<div>
							<label for="poc-cwe" class="block text-sm font-medium text-gray-700 mb-1">CWE ID</label>
							<input
								id="poc-cwe"
								type="text"
								bind:value={formData.cweId}
								placeholder="如: CWE-79"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							/>
						</div>
					</div>

					<!-- 描述 -->
					<div>
						<label for="poc-description" class="block text-sm font-medium text-gray-700 mb-1">
							描述 <span class="text-red-500">*</span>
						</label>
						<textarea
							id="poc-description"
							bind:value={formData.description}
							rows={3}
							placeholder="输入POC描述..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							class:border-red-500={errors.description}
						></textarea>
						{#if errors.description}
							<p class="text-red-500 text-xs mt-1">{errors.description}</p>
						{/if}
					</div>

					<!-- 引用链接 -->
					<div>
						<label for="poc-references" class="block text-sm font-medium text-gray-700 mb-1">引用链接</label>
						<textarea
							id="poc-references"
							bind:value={referencesInput}
							rows={3}
							placeholder="每行一个URL..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						></textarea>
						<p class="text-xs text-gray-500 mt-1">每行输入一个URL</p>
					</div>

					<!-- 标签 -->
					<div>
						<label for="poc-tags" class="block text-sm font-medium text-gray-700 mb-1">标签</label>
						<input
							id="poc-tags"
							type="text"
							bind:value={tagsInput}
							placeholder="用逗号分隔标签..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						/>
						<p class="text-xs text-gray-500 mt-1">用逗号分隔多个标签</p>
					</div>

					<!-- 脚本 -->
					<div>
						<div class="flex justify-between items-center mb-2">
							<label for="poc-script" class="block text-sm font-medium text-gray-700">
								POC脚本 <span class="text-red-500">*</span>
							</label>
							<div class="flex gap-2">
								<select
									bind:value={formData.scriptType}
									class="px-3 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
								>
									<option value="yaml">YAML</option>
									<option value="python">Python</option>
									<option value="go">Go</option>
									<option value="nuclei">Nuclei</option>
									<option value="javascript">JavaScript</option>
								</select>
								<Button size="sm" variant="outline" onclick={insertTemplate}>插入模板</Button>
								<Button
									size="sm"
									variant="outline"
									onclick={validateScript}
									disabled={isValidating || !formData.script.trim()}
								>
									{isValidating ? '验证中...' : '验证脚本'}
								</Button>
							</div>
						</div>
						<textarea
							id="poc-script"
							bind:value={formData.script}
							rows={15}
							placeholder="输入POC脚本内容..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
							class:border-red-500={errors.script}
						></textarea>
						{#if errors.script}
							<p class="text-red-500 text-xs mt-1">{errors.script}</p>
						{/if}

						<!-- 验证结果 -->
						{#if validationResult}
							<div class="mt-2">
								{#if validationResult.valid}
									<div
										class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded text-sm"
									>
										✅ 脚本验证通过
									</div>
								{:else}
									<div
										class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded text-sm"
									>
										❌ 脚本验证失败：
										<ul class="mt-1 ml-4 list-disc">
											{#each validationResult.errors as error}
												<li>{error}</li>
											{/each}
										</ul>
									</div>
								{/if}
							</div>
						{/if}
					</div>

					<!-- 参数配置 -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="poc-required-params" class="block text-sm font-medium text-gray-700 mb-1">必需参数</label>
							<input
								id="poc-required-params"
								type="text"
								bind:value={requiredParamsInput}
								placeholder="用逗号分隔参数名..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							/>
							<p class="text-xs text-gray-500 mt-1">如: url, token, user_agent</p>
						</div>

						<div>
							<label for="poc-default-params" class="block text-sm font-medium text-gray-700 mb-1">默认参数</label>
							<textarea
								id="poc-default-params"
								bind:value={defaultParamsInput}
								rows={3}
								placeholder="key=value格式，每行一个..."
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
							></textarea>
							<p class="text-xs text-gray-500 mt-1">如: timeout=10</p>
						</div>
					</div>

					<!-- 操作按钮 -->
					<div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
						<Button variant="outline" onclick={cancel} disabled={isSaving}>取消</Button>
						<Button onclick={save} disabled={isSaving}>
							{isSaving ? '保存中...' : '保存'}
						</Button>
					</div>
				</CardContent>
			</Card>
		</div>
	</div>
{/if}
