<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		vulnerabilityList,
		vulnerabilityPagination,
		vulnerabilityFilters
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { SEVERITY_CONFIG, STATUS_CONFIG, TYPE_CONFIG } from '$lib/types/vulnerability';
	import type {
		Vulnerability,
		VulnerabilitySeverity,
		VulnerabilityStatus,
		VulnerabilityType
	} from '$lib/types/vulnerability';

	// å¤–éƒ¨å±æ€§
	let {
		taskId = null,
		projectId = null,
		vulnerabilities: propsVulnerabilities = null, // æ·»åŠ  vulnerabilities å±æ€§
		showFilters = true,
		showActions = true
	} = $props();

	// ç»„ä»¶çŠ¶æ€
	let isLoading = $state(false);
	let showDetailDialog = $state(false);
	let selectedVuln = $state<Vulnerability | null>(null);
	let selectedVulns = $state<string[]>([]);

	// åˆ—è¡¨çŠ¶æ€
	let vulnerabilities = $state<Vulnerability[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		projectId: projectId,
		severity: undefined as VulnerabilitySeverity | undefined,
		status: undefined as VulnerabilityStatus | undefined,
		type: undefined as VulnerabilityType | undefined,
		search: undefined as string | undefined
	});

	// è®¢é˜… store å˜åŒ–
	$effect(() => {
		// å¦‚æœé€šè¿‡ props ä¼ å…¥äº† vulnerabilitiesï¼Œä½¿ç”¨å®ƒè€Œä¸æ˜¯ store
		if (propsVulnerabilities) {
			vulnerabilities = propsVulnerabilities;
			return;
		}

		const unsubscribeVulns = vulnerabilityList.subscribe((value) => (vulnerabilities = value));
		const unsubscribePagination = vulnerabilityPagination.subscribe(
			(value) => (pagination = value)
		);
		const unsubscribeFilters = vulnerabilityFilters.subscribe((value) => {
			filters = { ...value, projectId: projectId };
		});

		return () => {
			unsubscribeVulns();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
	onMount(() => {
		loadVulnerabilities();
	});

	// å½“taskIdå˜åŒ–æ—¶é‡æ–°åŠ è½½
	$effect(() => {
		if (taskId) {
			loadVulnerabilities();
		}
	});

	// åŠ è½½æ¼æ´åˆ—è¡¨
	async function loadVulnerabilities() {
		isLoading = true;
		try {
			await vulnStore.loadVulnerabilities({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters,
				...(projectId && { projectId })
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: 'åŠ è½½æ¼æ´åˆ—è¡¨å¤±è´¥: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// åˆ†é¡µå¤„ç†
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadVulnerabilities();
	}

	// è¿‡æ»¤å¤„ç†
	function handleFilterChange() {
		pagination.page = 1;
		loadVulnerabilities();
	}

	// æœç´¢å¤„ç†
	function handleSearch(event: Event) {
		const target = event.target as HTMLInputElement;
		filters.search = target.value || undefined;
		handleFilterChange();
	}

	// æŸ¥çœ‹æ¼æ´è¯¦æƒ…
	function viewDetail(vuln: Vulnerability) {
		selectedVuln = vuln;
		showDetailDialog = true;
	}

	// æ›´æ–°æ¼æ´çŠ¶æ€
	async function updateStatus(vuln: Vulnerability, status: VulnerabilityStatus) {
		const success = await vulnStore.updateVulnerabilityStatus(vuln.id, status);
		if (success) {
			loadVulnerabilities();
		}
	}

	// æ‰¹é‡æ“ä½œ
	function handleSelectAll(checked: boolean) {
		if (checked) {
			selectedVulns = vulnerabilities.map((v) => v.id);
		} else {
			selectedVulns = [];
		}
	}

	function toggleSelection(vulnId: string) {
		if (selectedVulns.includes(vulnId)) {
			selectedVulns = selectedVulns.filter((id) => id !== vulnId);
		} else {
			selectedVulns = [...selectedVulns, vulnId];
		}
	}

	// æ‰¹é‡æ›´æ–°çŠ¶æ€
	async function batchUpdateStatus(status: VulnerabilityStatus) {
		if (selectedVulns.length === 0) {
			notifications.add({
				type: 'warning',
				message: 'è¯·å…ˆé€‰æ‹©è¦æ›´æ–°çš„æ¼æ´'
			});
			return;
		}

		// è¿™é‡Œåº”è¯¥è°ƒç”¨æ‰¹é‡æ›´æ–°API
		notifications.add({
			type: 'info',
			message: `æ‰¹é‡æ›´æ–° ${selectedVulns.length} ä¸ªæ¼æ´çŠ¶æ€ä¸º: ${STATUS_CONFIG[status].label}`
		});
		selectedVulns = [];
		loadVulnerabilities();
	}

	// å¯¼å‡ºæ¼æ´
	async function exportVulnerabilities(format: 'json' | 'csv' | 'pdf' | 'html') {
		try {
			// TODO: å®ç°å¯¼å‡ºAPIï¼Œç›®å‰å…ˆæ³¨é‡Šæ‰formatå‚æ•°
			await vulnStore.loadVulnerabilities({
				...filters
				// format - å½“å¯¼å‡ºAPIå®ç°åæ·»åŠ 
			});

			// ä¸´æ—¶å¤„ç†ï¼Œå› ä¸ºå½“å‰APIæ²¡æœ‰è¿”å›code
			notifications.add({
				type: 'success',
				message: `å¯¼å‡º${format.toUpperCase()}æ–‡ä»¶æˆåŠŸ`
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: 'å¯¼å‡ºå¤±è´¥: ' + errorMessage
			});
		}
	}

	// è·å–ä¸¥é‡æ€§æ ·å¼
	function getSeverityClass(severity: VulnerabilitySeverity) {
		const config = SEVERITY_CONFIG[severity];
		return `${config.bgColor} ${config.textColor} ${config.borderColor}`;
	}

	// è·å–çŠ¶æ€æ ·å¼
	function getStatusClass(status: VulnerabilityStatus) {
		const config = STATUS_CONFIG[status];
		return `${config.bgColor} ${config.textColor}`;
	}

	// æ ¼å¼åŒ–æ—¥æœŸ
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN', {
			year: 'numeric',
			month: '2-digit',
			day: '2-digit',
			hour: '2-digit',
			minute: '2-digit'
		});
	}

	// è·å–æ¼æ´ç±»å‹é…ç½®
	function getTypeConfig(type: VulnerabilityType) {
		return TYPE_CONFIG[type];
	}

	// æˆªæ–­æ–‡æœ¬
	function truncateText(text: string, maxLength: number): string {
		if (text.length <= maxLength) return text;
		return text.substring(0, maxLength) + '...';
	}
</script>

<div class="space-y-6">
	<!-- æ ‡é¢˜å’Œæ“ä½œæ  -->
	<div class="flex justify-between items-center">
		<div>
			<h2 class="text-2xl font-bold text-gray-900">æ¼æ´åˆ—è¡¨</h2>
			<p class="text-gray-600 mt-1">
				å…±å‘ç° {pagination.total} ä¸ªæ¼æ´
				{#if selectedVulns.length > 0}
					<span class="ml-2 text-blue-600">å·²é€‰æ‹© {selectedVulns.length} ä¸ª</span>
				{/if}
			</p>
		</div>

		{#if showActions}
			<div class="flex gap-3">
				<!-- æ‰¹é‡æ“ä½œ -->
				{#if selectedVulns.length > 0}
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('verified')}>
						æ ‡è®°ä¸ºå·²éªŒè¯
					</Button>
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('fixed')}>
						æ ‡è®°ä¸ºå·²ä¿®å¤
					</Button>
					<Button size="sm" variant="outline" onclick={() => batchUpdateStatus('ignored')}>
						æ ‡è®°ä¸ºå·²å¿½ç•¥
					</Button>
				{/if}

				<!-- å¯¼å‡º -->
				<div class="relative group">
					<Button size="sm" variant="outline">å¯¼å‡º</Button>
					<div
						class="absolute right-0 top-full mt-1 w-32 bg-white border border-gray-200 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10"
					>
						<button
							onclick={() => exportVulnerabilities('json')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">JSON</button
						>
						<button
							onclick={() => exportVulnerabilities('csv')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">CSV</button
						>
						<button
							onclick={() => exportVulnerabilities('pdf')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">PDF</button
						>
						<button
							onclick={() => exportVulnerabilities('html')}
							class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50">HTML</button
						>
					</div>
				</div>

				<Button
					size="sm"
					variant="outline"
					onclick={() => loadVulnerabilities()}
					disabled={isLoading}
				>
					{isLoading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}
				</Button>
			</div>
		{/if}
	</div>

	<!-- è¿‡æ»¤æ  -->
	{#if showFilters}
		<Card>
			<CardContent class="p-4">
				<div class="grid grid-cols-1 md:grid-cols-5 gap-4">
					<!-- æœç´¢æ¡† -->
					<div>
						<label for="vuln-search" class="block text-sm font-medium text-gray-700 mb-1">æœç´¢</label>
						<input
							id="vuln-search"
							type="text"
							value={filters.search || ''}
							onkeyup={handleSearch}
							placeholder="æœç´¢æ¼æ´æ ‡é¢˜æˆ–URL..."
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						/>
					</div>

					<!-- ä¸¥é‡æ€§è¿‡æ»¤ -->
					<div>
						<label for="vuln-severity-filter" class="block text-sm font-medium text-gray-700 mb-1">ä¸¥é‡æ€§</label>
						<select
							id="vuln-severity-filter"
							bind:value={filters.severity}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>å…¨éƒ¨ä¸¥é‡æ€§</option>
							<option value="critical">ä¸¥é‡</option>
							<option value="high">é«˜å±</option>
							<option value="medium">ä¸­å±</option>
							<option value="low">ä½å±</option>
							<option value="info">ä¿¡æ¯</option>
						</select>
					</div>

					<!-- çŠ¶æ€è¿‡æ»¤ -->
					<div>
						<label for="vulnerability-status-filter" class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
						<select
							id="vulnerability-status-filter"
							bind:value={filters.status}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>å…¨éƒ¨çŠ¶æ€</option>
							<option value="unverified">æœªéªŒè¯</option>
							<option value="verified">å·²éªŒè¯</option>
							<option value="fixed">å·²ä¿®å¤</option>
							<option value="false_positive">è¯¯æŠ¥</option>
							<option value="ignored">å·²å¿½ç•¥</option>
						</select>
					</div>

					<!-- ç±»å‹è¿‡æ»¤ -->
					<div>
						<label for="vulnerability-type-filter" class="block text-sm font-medium text-gray-700 mb-1">ç±»å‹</label>
						<select
							id="vulnerability-type-filter"
							bind:value={filters.type}
							onchange={handleFilterChange}
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							<option value={undefined}>å…¨éƒ¨ç±»å‹</option>
							<option value="web">Webæ¼æ´</option>
							<option value="system">ç³»ç»Ÿæ¼æ´</option>
							<option value="network">ç½‘ç»œæ¼æ´</option>
							<option value="config">é…ç½®æ¼æ´</option>
							<option value="component">ç»„ä»¶æ¼æ´</option>
						</select>
					</div>

					<!-- ç»Ÿè®¡ä¿¡æ¯ -->
					<div class="flex items-end">
						<div class="text-sm text-gray-600">
							æ˜¾ç¤º {vulnerabilities.length} / {pagination.total} ä¸ªç»“æœ
						</div>
					</div>
				</div>
			</CardContent>
		</Card>
	{/if}

	<!-- æ¼æ´åˆ—è¡¨ -->
	<div class="space-y-4">
		<!-- å…¨é€‰å¤é€‰æ¡† -->
		{#if showActions && vulnerabilities.length > 0}
			<div class="flex items-center p-3 bg-gray-50 rounded-md">
				<input
					type="checkbox"
					checked={selectedVulns.length === vulnerabilities.length && vulnerabilities.length > 0}
					onchange={(e) => handleSelectAll((e.target as HTMLInputElement).checked)}
					class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
				/>
				<span class="text-sm text-gray-700">
					å…¨é€‰ ({selectedVulns.length}/{vulnerabilities.length})
				</span>
			</div>
		{/if}

		{#each vulnerabilities as vuln (vuln.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardContent class="p-6">
					<div class="flex items-start gap-4">
						<!-- é€‰æ‹©æ¡† -->
						{#if showActions}
							<input
								type="checkbox"
								checked={selectedVulns.includes(vuln.id)}
								onchange={() => toggleSelection(vuln.id)}
								class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1"
							/>
						{/if}

						<!-- æ¼æ´ä¿¡æ¯ -->
						<div class="flex-1">
							<!-- æ ‡é¢˜å’Œæ ‡ç­¾ -->
							<div class="flex items-start justify-between mb-3">
								<div class="flex-1">
									<h3 class="text-lg font-semibold text-gray-900 mb-2">{vuln.title}</h3>
									<div class="flex flex-wrap gap-2">
										<Badge class={getSeverityClass(vuln.severity)}>
											{SEVERITY_CONFIG[vuln.severity].label}
										</Badge>
										<Badge class={getStatusClass(vuln.status)}>
											{STATUS_CONFIG[vuln.status].label}
										</Badge>
										<Badge variant="outline">
											{getTypeConfig(vuln.type).icon}
											{getTypeConfig(vuln.type).label}
										</Badge>
										{#if vuln.cveId}
											<Badge variant="outline">{vuln.cveId}</Badge>
										{/if}
										{#if vuln.cweId}
											<Badge variant="outline">{vuln.cweId}</Badge>
										{/if}
									</div>
								</div>

								<!-- è¯„åˆ† -->
								<div class="text-right ml-4">
									<div class="text-2xl font-bold text-gray-900">{vuln.score}</div>
									<div class="text-xs text-gray-500">CVSSè¯„åˆ†</div>
								</div>
							</div>

							<!-- æè¿° -->
							<p class="text-gray-700 mb-3 line-clamp-2">{vuln.description}</p>

							<!-- è¯¦ç»†ä¿¡æ¯ -->
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
								<div>
									<div class="text-sm text-gray-500 mb-1">å½±å“ç›®æ ‡</div>
									<div class="text-sm">
										<div>
											URL: <span class="font-mono text-blue-600"
												>{truncateText(vuln.affectedUrl, 50)}</span
											>
										</div>
										<div>Host: {vuln.affectedHost}</div>
										{#if vuln.affectedPort}
											<div>Port: {vuln.affectedPort}</div>
										{/if}
										{#if vuln.affectedParam}
											<div>å‚æ•°: {vuln.affectedParam}</div>
										{/if}
									</div>
								</div>

								<div>
									<div class="text-sm text-gray-500 mb-1">æ£€æµ‹ä¿¡æ¯</div>
									<div class="text-sm">
										<div>POC: {vuln.pocName}</div>
										<div>å‘ç°æ—¶é—´: {formatDate(vuln.discoveredAt)}</div>
										{#if vuln.verifiedAt}
											<div>éªŒè¯æ—¶é—´: {formatDate(vuln.verifiedAt)}</div>
										{/if}
										{#if vuln.fixedAt}
											<div>ä¿®å¤æ—¶é—´: {formatDate(vuln.fixedAt)}</div>
										{/if}
									</div>
								</div>
							</div>

							<!-- Payloadé¢„è§ˆ -->
							{#if vuln.payload}
								<div class="mb-3">
									<div class="text-sm text-gray-500 mb-1">Payload</div>
									<div class="bg-gray-50 p-2 rounded text-sm font-mono text-gray-800 truncate">
										{truncateText(vuln.payload, 100)}
									</div>
								</div>
							{/if}

							<!-- æ ‡ç­¾ -->
							{#if vuln.tags && vuln.tags.length > 0}
								<div class="flex flex-wrap gap-1 mb-3">
									{#each vuln.tags.slice(0, 5) as tag}
										<Badge variant="outline" class="text-xs">{tag}</Badge>
									{/each}
									{#if vuln.tags.length > 5}
										<Badge variant="outline" class="text-xs">+{vuln.tags.length - 5}</Badge>
									{/if}
								</div>
							{/if}
						</div>

						<!-- æ“ä½œæŒ‰é’® -->
						{#if showActions}
							<div class="flex flex-col gap-2">
								<Button size="sm" onclick={() => viewDetail(vuln)}>æŸ¥çœ‹è¯¦æƒ…</Button>

								{#if vuln.status === 'unverified'}
									<Button
										size="sm"
										variant="outline"
										onclick={() => updateStatus(vuln, 'verified')}
									>
										éªŒè¯
									</Button>
								{:else if vuln.status === 'verified'}
									<Button size="sm" variant="outline" onclick={() => updateStatus(vuln, 'fixed')}>
										æ ‡è®°ä¿®å¤
									</Button>
								{/if}

								<Button size="sm" variant="outline" onclick={() => updateStatus(vuln, 'ignored')}>
									å¿½ç•¥
								</Button>
							</div>
						{/if}
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{#if !isLoading && vulnerabilities.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">ğŸ”’</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">æš‚æ— æ¼æ´</h3>
			<p class="text-gray-500">{taskId ? 'æ­¤æ¬¡æ‰«ææœªå‘ç°æ¼æ´' : 'è¿˜æ²¡æœ‰å‘ç°ä»»ä½•æ¼æ´'}</p>
		</div>
	{/if}

	<!-- åˆ†é¡µ -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					ä¸Šä¸€é¡µ
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					ç¬¬ {pagination.page} é¡µï¼Œå…± {pagination.totalPages} é¡µ
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					ä¸‹ä¸€é¡µ
				</Button>
			</div>
		</div>
	{/if}

	<!-- åŠ è½½çŠ¶æ€ -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">åŠ è½½ä¸­...</p>
			</div>
		</div>
	{/if}
</div>

<!-- æ¼æ´è¯¦æƒ…å¯¹è¯æ¡† -->
{#if showDetailDialog && selectedVuln}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
		<div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
			<Card>
				<CardHeader>
					<div class="flex justify-between items-start">
						<CardTitle>æ¼æ´è¯¦æƒ…</CardTitle>
						<Button variant="outline" size="sm" onclick={() => (showDetailDialog = false)}>
							å…³é—­
						</Button>
					</div>
				</CardHeader>

				<CardContent class="space-y-6">
					<!-- åŸºæœ¬ä¿¡æ¯ -->
					<div>
						<h3 class="text-lg font-semibold mb-3">{selectedVuln.title}</h3>
						<div class="flex flex-wrap gap-2 mb-4">
							<Badge class={getSeverityClass(selectedVuln.severity)}>
								{SEVERITY_CONFIG[selectedVuln.severity].label}
							</Badge>
							<Badge class={getStatusClass(selectedVuln.status)}>
								{STATUS_CONFIG[selectedVuln.status].label}
							</Badge>
							<Badge variant="outline">
								{getTypeConfig(selectedVuln.type).label}
							</Badge>
							{#if selectedVuln.cveId}
								<Badge variant="outline">{selectedVuln.cveId}</Badge>
							{/if}
							{#if selectedVuln.cweId}
								<Badge variant="outline">{selectedVuln.cweId}</Badge>
							{/if}
						</div>
						<p class="text-gray-700">{selectedVuln.description}</p>
					</div>

					<!-- å½±å“ä¿¡æ¯ -->
					<div>
						<h4 class="font-semibold mb-2">å½±å“ä¿¡æ¯</h4>
						<div class="bg-gray-50 p-4 rounded">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<div class="text-sm font-medium text-gray-700">URL</div>
									<div class="font-mono text-sm break-all">{selectedVuln.affectedUrl}</div>
								</div>
								<div>
									<div class="text-sm font-medium text-gray-700">ä¸»æœº</div>
									<div class="text-sm">{selectedVuln.affectedHost}</div>
								</div>
								{#if selectedVuln.affectedPort}
									<div>
										<div class="text-sm font-medium text-gray-700">ç«¯å£</div>
										<div class="text-sm">{selectedVuln.affectedPort}</div>
									</div>
								{/if}
								{#if selectedVuln.affectedParam}
									<div>
										<div class="text-sm font-medium text-gray-700">å‚æ•°</div>
										<div class="text-sm">{selectedVuln.affectedParam}</div>
									</div>
								{/if}
							</div>
						</div>
					</div>

					<!-- æŠ€æœ¯ç»†èŠ‚ -->
					<div>
						<h4 class="font-semibold mb-2">æŠ€æœ¯ç»†èŠ‚</h4>
						<div class="space-y-4">
							{#if selectedVuln.payload}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">Payload</div>
									<pre
										class="bg-gray-900 text-green-400 p-3 rounded text-sm overflow-x-auto">{selectedVuln.payload}</pre>
								</div>
							{/if}

							{#if selectedVuln.request}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">è¯·æ±‚</div>
									<pre
										class="bg-gray-50 p-3 rounded text-sm overflow-x-auto border">{selectedVuln.request}</pre>
								</div>
							{/if}

							{#if selectedVuln.response}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-1">å“åº”</div>
									<pre
										class="bg-gray-50 p-3 rounded text-sm overflow-x-auto border max-h-60">{selectedVuln.response}</pre>
								</div>
							{/if}
						</div>
					</div>

					<!-- ä¿®å¤å»ºè®® -->
					{#if selectedVuln.solution}
						<div>
							<h4 class="font-semibold mb-2">ä¿®å¤å»ºè®®</h4>
							<div class="bg-blue-50 border border-blue-200 p-4 rounded">
								<p class="text-blue-800">{selectedVuln.solution}</p>
							</div>
						</div>
					{/if}

					<!-- å‚è€ƒé“¾æ¥ -->
					{#if selectedVuln.references && selectedVuln.references.length > 0}
						<div>
							<h4 class="font-semibold mb-2">å‚è€ƒé“¾æ¥</h4>
							<ul class="list-disc list-inside space-y-1">
								{#each selectedVuln.references as ref}
									<li>
										<a href={ref} target="_blank" class="text-blue-600 hover:underline">{ref}</a>
									</li>
								{/each}
							</ul>
						</div>
					{/if}

					<!-- æ—¶é—´ä¿¡æ¯ -->
					<div>
						<h4 class="font-semibold mb-2">æ—¶é—´ä¿¡æ¯</h4>
						<div class="text-sm text-gray-600 space-y-1">
							<div>å‘ç°æ—¶é—´: {formatDate(selectedVuln.discoveredAt)}</div>
							{#if selectedVuln.verifiedAt}
								<div>éªŒè¯æ—¶é—´: {formatDate(selectedVuln.verifiedAt)}</div>
							{/if}
							{#if selectedVuln.fixedAt}
								<div>ä¿®å¤æ—¶é—´: {formatDate(selectedVuln.fixedAt)}</div>
							{/if}
							<div>åˆ›å»ºæ—¶é—´: {formatDate(selectedVuln.createdAt)}</div>
							<div>æ›´æ–°æ—¶é—´: {formatDate(selectedVuln.updatedAt)}</div>
						</div>
					</div>
				</CardContent>
			</Card>
		</div>
	</div>
{/if}

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
