<script lang="ts">
	import { onMount, onDestroy } from 'svelte';
	import { get } from 'svelte/store';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import { vulnStore, scanTasks } from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { TASK_STATUS_CONFIG } from '$lib/types/vulnerability';
	import type { VulnScanTask } from '$lib/types/vulnerability';

	interface SeverityDistributionItem {
		label: string;
		count: number;
		percentage: number;
		color: string;
	}

	// 外部属性
	let { refreshInterval = 5000, showAll = false } = $props(); // 默认5秒刷新一次

	// 组件状态
	let isLoading = $state(false);
	let runningTasks = $state<VulnScanTask[]>([]);
	let allTasks = $state<VulnScanTask[]>([]);
	let selectedTaskId = $state<string | null>(null);
	let intervalId = $state<ReturnType<typeof setInterval> | null>(null);

	// 页面加载时开始监控
	onMount(() => {
		loadTasks();
		startMonitoring();
	});

	// 页面卸载时停止监控
	onDestroy(() => {
		stopMonitoring();
	});

	// 开始监控
	function startMonitoring() {
		if (intervalId) return;

		intervalId = setInterval(() => {
			loadTasks();
		}, refreshInterval);
	}

	// 停止监控
	function stopMonitoring() {
		if (intervalId) {
			clearInterval(intervalId);
			intervalId = null;
		}
	}

	// 加载任务列表
	async function loadTasks() {
		if (isLoading) return;

		isLoading = true;
		try {
			if (showAll) {
				// 加载所有任务
				await vulnStore.loadScanTasks({ pageSize: 50 });
				allTasks = get(scanTasks) || [];
			} else {
				// 只加载运行中的任务
				await vulnStore.loadScanTasks({
					status: 'running',
					pageSize: 50
				});
				runningTasks = get(scanTasks) || [];
			}
		} catch (error) {
			console.error('加载任务失败:', error);
			// 不显示错误通知，避免频繁弹出
		} finally {
			isLoading = false;
		}
	}

	// 获取要显示的任务列表
	function getDisplayTasks(): VulnScanTask[] {
		if (showAll) {
			return allTasks.filter((task) => ['pending', 'queued', 'running'].includes(task.status));
		}
		return runningTasks;
	}

	// 停止任务
	async function stopTask(task: VulnScanTask) {
		const success = await vulnStore.stopScanTask(task.id);
		if (success) {
			await loadTasks();
		}
	}

	// 查看任务详情
	function viewTaskDetail(taskId: string) {
		window.open(`/vulnerability/results/${taskId}`, '_blank');
	}

	// 获取状态样式
	function getStatusClass(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? `${config.bgColor} ${config.textColor}` : 'bg-gray-100 text-gray-800';
	}

	// 获取状态标签
	function getStatusLabel(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? config.label : status;
	}

	// 计算进度百分比
	function getProgressPercentage(task: VulnScanTask): number {
		return Math.round(task.progress || 0);
	}

	// 格式化时间
	function formatTime(dateStr: string) {
		return new Date(dateStr).toLocaleTimeString('zh-CN');
	}

	// 计算运行时间
	function getRunningTime(startTime: string): string {
		const start = new Date(startTime);
		const now = new Date();
		const diff = now.getTime() - start.getTime();

		const hours = Math.floor(diff / (1000 * 60 * 60));
		const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
		const seconds = Math.floor((diff % (1000 * 60)) / 1000);

		if (hours > 0) {
			return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
		} else {
			return `${minutes}:${seconds.toString().padStart(2, '0')}`;
		}
	}

	// 获取严重性分布
	function getSeverityDistribution(task: VulnScanTask): SeverityDistributionItem[] {
		const summary = task.resultSummary;
		if (!summary) return [];

		const total = summary.totalVulns;
		if (total === 0) return [];

		return [
			{
				label: '严重',
				count: summary.criticalVulns,
				percentage: Math.round((summary.criticalVulns / total) * 100),
				color: 'bg-red-500'
			},
			{
				label: '高危',
				count: summary.highVulns,
				percentage: Math.round((summary.highVulns / total) * 100),
				color: 'bg-orange-500'
			},
			{
				label: '中危',
				count: summary.mediumVulns,
				percentage: Math.round((summary.mediumVulns / total) * 100),
				color: 'bg-yellow-500'
			},
			{
				label: '低危',
				count: summary.lowVulns,
				percentage: Math.round((summary.lowVulns / total) * 100),
				color: 'bg-blue-500'
			},
			{
				label: '信息',
				count: summary.infoVulns,
				percentage: Math.round((summary.infoVulns / total) * 100),
				color: 'bg-gray-500'
			}
		].filter((item) => item.count > 0);
	}

	// 切换监控模式
	function toggleMonitoring() {
		if (intervalId) {
			stopMonitoring();
		} else {
			startMonitoring();
		}
	}

	// 手动刷新
	async function refresh() {
		await loadTasks();
		notifications.add({
			type: 'success',
			message: '任务状态已刷新'
		});
	}

	// 导出监控数据
	function exportMonitoringData() {
		const tasks = getDisplayTasks();
		const data = tasks.map((task) => ({
			id: task.id,
			name: task.taskName,
			status: task.status,
			progress: task.progress,
			vulnerabilities: task.resultSummary?.totalVulns || 0,
			startTime: task.startedAt,
			targets: task.targets.length
		}));

		const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = `scan-monitoring-${new Date().toISOString().split('T')[0]}.json`;
		a.click();
		URL.revokeObjectURL(url);
	}
</script>

<div class="space-y-6">
	<!-- 监控控制栏 -->
	<Card>
		<CardContent class="p-4">
			<div class="flex justify-between items-center">
				<div class="flex items-center gap-4">
					<h2 class="text-lg font-semibold text-gray-900">
						{showAll ? '任务监控' : '运行中任务监控'}
					</h2>
					<div class="flex items-center gap-2">
						<div class="w-2 h-2 rounded-full {intervalId ? 'bg-green-500' : 'bg-red-500'}"></div>
						<span class="text-sm text-gray-600">
							{intervalId ? '实时监控中' : '监控已暂停'}
						</span>
					</div>
				</div>

				<div class="flex items-center gap-3">
					<label class="flex items-center gap-2 text-sm">
						<input
							type="checkbox"
							bind:checked={showAll}
							onchange={loadTasks}
							class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
						/>
						显示所有任务
					</label>

					<Button size="sm" variant="outline" onclick={exportMonitoringData}>导出数据</Button>

					<Button size="sm" variant="outline" onclick={refresh} disabled={isLoading}>
						{isLoading ? '刷新中...' : '刷新'}
					</Button>

					<Button
						size="sm"
						variant={intervalId ? 'destructive' : 'default'}
						onclick={toggleMonitoring}
					>
						{intervalId ? '暂停监控' : '开始监控'}
					</Button>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- 任务监控列表 -->
	{#if getDisplayTasks().length > 0}
		<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
			{#each getDisplayTasks() as task (task.id)}
				<Card
					class="hover:shadow-lg transition-shadow cursor-pointer"
					onclick={() => (selectedTaskId = selectedTaskId === task.id ? null : task.id)}
				>
					<CardHeader class="pb-3">
						<div class="flex justify-between items-start">
							<CardTitle class="text-lg font-semibold text-gray-900 truncate">
								{task.taskName}
							</CardTitle>
							<Badge class={getStatusClass(task.status)}>
								{getStatusLabel(task.status)}
							</Badge>
						</div>
					</CardHeader>

					<CardContent>
						<div class="space-y-4">
							<!-- 进度条 -->
							{#if task.status === 'running'}
								<div>
									<div class="flex justify-between items-center mb-1">
										<span class="text-sm font-medium text-gray-700">扫描进度</span>
										<span class="text-sm text-gray-600">{getProgressPercentage(task)}%</span>
									</div>
									<div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
										<div
											class="h-full bg-blue-500 transition-all duration-500"
											style="width: {getProgressPercentage(task)}%"
										></div>
									</div>
									<div class="text-xs text-gray-500 mt-1">
										{task.resultSummary?.scannedTargets || 0} / {task.resultSummary?.totalTargets ||
											0} 个目标
									</div>
								</div>
							{/if}

							<!-- 基本信息 -->
							<div class="grid grid-cols-2 gap-4 text-sm">
								<div>
									<div class="text-gray-500">目标数量</div>
									<div class="font-medium">{task.targets.length}</div>
								</div>
								<div>
									<div class="text-gray-500">发现漏洞</div>
									<div class="font-medium text-red-600">{task.resultSummary?.totalVulns || 0}</div>
								</div>
								{#if task.startedAt}
									<div>
										<div class="text-gray-500">开始时间</div>
										<div class="font-medium">{formatTime(task.startedAt)}</div>
									</div>
									<div>
										<div class="text-gray-500">运行时间</div>
										<div class="font-medium">{getRunningTime(task.startedAt)}</div>
									</div>
								{/if}
							</div>

							<!-- 漏洞严重性分布 -->
							{#if task.resultSummary && task.resultSummary.totalVulns > 0}
								<div>
									<div class="text-sm font-medium text-gray-700 mb-2">漏洞分布</div>
									<div class="flex h-2 bg-gray-200 rounded-full overflow-hidden">
										{#each getSeverityDistribution(task) as item}
											<div
												class={item.color}
												style="width: {item.percentage}%"
												title="{item.label}: {item.count}"
											></div>
										{/each}
									</div>
									<div class="flex justify-between text-xs text-gray-500 mt-1">
										{#each getSeverityDistribution(task) as item}
											<span>{item.label}: {item.count}</span>
										{/each}
									</div>
								</div>
							{/if}

							<!-- 错误信息 -->
							{#if task.error}
								<div class="bg-red-50 border border-red-200 text-red-800 p-2 rounded text-xs">
									错误: {task.error}
								</div>
							{/if}

							<!-- 展开的详细信息 -->
							{#if selectedTaskId === task.id}
								<div class="border-t border-gray-200 pt-4 space-y-3">
									<!-- 目标预览 -->
									<div>
										<div class="text-sm font-medium text-gray-700 mb-1">扫描目标</div>
										<div class="max-h-20 overflow-y-auto text-xs text-gray-600 space-y-1">
											{#each task.targets.slice(0, 5) as target}
												<div class="font-mono truncate">{target}</div>
											{/each}
											{#if task.targets.length > 5}
												<div class="text-gray-500">...还有 {task.targets.length - 5} 个目标</div>
											{/if}
										</div>
									</div>

									<!-- 配置信息 -->
									<div class="grid grid-cols-2 gap-2 text-xs">
										<div>
											<span class="text-gray-500">并发数:</span>
											<span class="ml-1">{task.config.concurrency}</span>
										</div>
										<div>
											<span class="text-gray-500">超时:</span>
											<span class="ml-1">{task.config.timeout}s</span>
										</div>
										<div>
											<span class="text-gray-500">POC数:</span>
											<span class="ml-1">{task.config.pocIds?.length || 0}</span>
										</div>
										<div>
											<span class="text-gray-500">节点:</span>
											<span class="ml-1">{task.nodeId || 'local'}</span>
										</div>
									</div>

									<!-- 操作按钮 -->
									<div class="flex gap-2">
										<Button
											size="sm"
											onclick={(e: Event) => {
												e.stopPropagation();
												viewTaskDetail(task.id);
											}}
										>
											查看详情
										</Button>

										{#if task.status === 'running'}
											<Button
												size="sm"
												variant="destructive"
												onclick={(e: Event) => {
													e.stopPropagation();
													stopTask(task);
												}}
											>
												停止
											</Button>
										{/if}
									</div>
								</div>
							{/if}
						</div>
					</CardContent>
				</Card>
			{/each}
		</div>
	{:else}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">
				{showAll ? '📊' : '⏱️'}
			</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">
				{showAll ? '暂无任务' : '暂无运行中的任务'}
			</h3>
			<p class="text-gray-500">
				{showAll ? '还没有创建任何扫描任务' : '当前没有正在执行的扫描任务'}
			</p>
		</div>
	{/if}

	<!-- 监控统计 -->
	{#if getDisplayTasks().length > 0}
		<Card>
			<CardHeader>
				<CardTitle>监控统计</CardTitle>
			</CardHeader>
			<CardContent>
				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div class="text-center">
						<div class="text-2xl font-bold text-blue-600">
							{getDisplayTasks().filter((t) => t.status === 'running').length}
						</div>
						<div class="text-sm text-gray-600">运行中</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-yellow-600">
							{getDisplayTasks().filter((t) => ['pending', 'queued'].includes(t.status)).length}
						</div>
						<div class="text-sm text-gray-600">等待中</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-green-600">
							{getDisplayTasks().reduce((sum, t) => sum + (t.resultSummary?.totalVulns || 0), 0)}
						</div>
						<div class="text-sm text-gray-600">发现漏洞</div>
					</div>
					<div class="text-center">
						<div class="text-2xl font-bold text-purple-600">
							{getDisplayTasks().reduce((sum, t) => sum + t.targets.length, 0)}
						</div>
						<div class="text-sm text-gray-600">扫描目标</div>
					</div>
				</div>
			</CardContent>
		</Card>
	{/if}
</div>
