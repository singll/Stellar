<script lang="ts">
	import { onMount } from 'svelte';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import {
		vulnStore,
		scanTaskList,
		scanTaskPagination,
		scanTaskFilters
	} from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { TASK_STATUS_CONFIG, SEVERITY_CONFIG } from '$lib/types/vulnerability';
	import type { VulnScanTask, VulnScanConfig } from '$lib/types/vulnerability';

	// å¤–éƒ¨å›è°ƒå±æ€§
	let {
		onCreateTask = () => {},
		onEditTask = () => {},
		onEdit = () => {}, // æ·»åŠ  onEdit å›è°ƒ
		onDelete = () => {}, // æ·»åŠ  onDelete å›è°ƒ
		onStart = () => {}, // æ·»åŠ  onStart å›è°ƒ
		onStop = () => {}, // æ·»åŠ  onStop å›è°ƒ
		onViewResults = () => {}
	} = $props();

	// ç»„ä»¶çŠ¶æ€
	let isLoading = $state(false);
	let showDeleteDialog = $state(false);
	let currentTask = $state<VulnScanTask | null>(null);

	// åˆ—è¡¨çŠ¶æ€
	let tasks = $state<VulnScanTask[]>([]);
	let pagination = $state({ page: 1, pageSize: 20, total: 0, totalPages: 0 });
	let filters = $state({
		projectId: undefined as string | undefined,
		status: undefined as string | undefined
	});

	// è®¢é˜… store å˜åŒ–
	$effect(() => {
		const unsubscribeTasks = scanTaskList.subscribe((value) => (tasks = value));
		const unsubscribePagination = scanTaskPagination.subscribe((value) => (pagination = value));
		const unsubscribeFilters = scanTaskFilters.subscribe((value) => (filters = value));

		return () => {
			unsubscribeTasks();
			unsubscribePagination();
			unsubscribeFilters();
		};
	});

	// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
	onMount(() => {
		loadTasks();
	});

	// åŠ è½½ä»»åŠ¡åˆ—è¡¨
	async function loadTasks() {
		isLoading = true;
		try {
			await vulnStore.loadScanTasks({
				page: pagination.page,
				pageSize: pagination.pageSize,
				...filters
			});
		} catch (error) {
			const errorMessage = error instanceof Error ? error.message : String(error);
			notifications.add({
				type: 'error',
				message: 'åŠ è½½æ‰«æä»»åŠ¡åˆ—è¡¨å¤±è´¥: ' + errorMessage
			});
		} finally {
			isLoading = false;
		}
	}

	// åˆ†é¡µå¤„ç†
	function handlePageChange(newPage: number) {
		pagination.page = newPage;
		loadTasks();
	}

	// è¿‡æ»¤å¤„ç†
	function handleFilterChange() {
		pagination.page = 1;
		loadTasks();
	}

	// åˆ é™¤ä»»åŠ¡
	function deleteTask(task: VulnScanTask) {
		currentTask = task;
		showDeleteDialog = true;
	}

	// ç¡®è®¤åˆ é™¤ä»»åŠ¡
	async function confirmDelete() {
		if (!currentTask) return;

		// è¿™é‡Œåº”è¯¥è°ƒç”¨åˆ é™¤API
		// const success = await vulnStore.deleteScanTask(currentTask.id);
		// if (success) {
		showDeleteDialog = false;
		currentTask = null;
		loadTasks();
		// }
	}

	// å¯åŠ¨ä»»åŠ¡
	async function startTask(task: VulnScanTask) {
		const success = await vulnStore.startScanTask(task.id);
		if (success) {
			loadTasks();
		}
	}

	// åœæ­¢ä»»åŠ¡
	async function stopTask(task: VulnScanTask) {
		const success = await vulnStore.stopScanTask(task.id);
		if (success) {
			loadTasks();
		}
	}

	// è·å–çŠ¶æ€æ ·å¼
	function getStatusClass(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? `${config.bgColor} ${config.textColor}` : 'bg-gray-100 text-gray-800';
	}

	// è·å–çŠ¶æ€æ ‡ç­¾
	function getStatusLabel(status: string) {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? config.label : status;
	}

	// æ ¼å¼åŒ–æ—¥æœŸ
	function formatDate(dateStr: string) {
		return new Date(dateStr).toLocaleDateString('zh-CN', {
			year: 'numeric',
			month: '2-digit',
			day: '2-digit',
			hour: '2-digit',
			minute: '2-digit'
		});
	}

	// æ ¼å¼åŒ–æŒç»­æ—¶é—´
	function formatDuration(startTime: string, endTime?: string) {
		const start = new Date(startTime);
		const end = endTime ? new Date(endTime) : new Date();
		const diff = end.getTime() - start.getTime();

		const hours = Math.floor(diff / (1000 * 60 * 60));
		const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
		const seconds = Math.floor((diff % (1000 * 60)) / 1000);

		if (hours > 0) {
			return `${hours}h ${minutes}m`;
		} else if (minutes > 0) {
			return `${minutes}m ${seconds}s`;
		} else {
			return `${seconds}s`;
		}
	}

	// è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
	function getProgressPercentage(task: VulnScanTask): number {
		return Math.round(task.progress || 0);
	}

	// è·å–æ¼æ´ä¸¥é‡æ€§ç»Ÿè®¡çš„æ˜¾ç¤º
	function getSeverityStats(summary: any) {
		if (!summary) return '';

		const stats = [];
		if (summary.criticalVulns > 0) stats.push(`ä¸¥é‡:${summary.criticalVulns}`);
		if (summary.highVulns > 0) stats.push(`é«˜å±:${summary.highVulns}`);
		if (summary.mediumVulns > 0) stats.push(`ä¸­å±:${summary.mediumVulns}`);
		if (summary.lowVulns > 0) stats.push(`ä½å±:${summary.lowVulns}`);
		if (summary.infoVulns > 0) stats.push(`ä¿¡æ¯:${summary.infoVulns}`);

		return stats.join(', ') || 'æ— æ¼æ´';
	}
</script>

<div class="container mx-auto p-6">
	<!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæ  -->
	<div class="flex justify-between items-center mb-6">
		<div>
			<h1 class="text-3xl font-bold text-gray-900">æ¼æ´æ‰«æä»»åŠ¡</h1>
			<p class="text-gray-600 mt-1">ç®¡ç†å’Œç›‘æ§æ¼æ´æ‰«æä»»åŠ¡</p>
		</div>
		<div class="flex gap-3">
			<Button onclick={() => loadTasks()} variant="outline" disabled={isLoading}>
				{isLoading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}
			</Button>
			<Button onclick={() => onCreateTask()}>åˆ›å»ºæ‰«æä»»åŠ¡</Button>
		</div>
	</div>

	<!-- è¿‡æ»¤æ  -->
	<Card class="mb-6">
		<CardContent class="p-4">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<!-- é¡¹ç›®è¿‡æ»¤ -->
				<div>
					<label for="project-filter" class="block text-sm font-medium text-gray-700 mb-1">é¡¹ç›®</label>
					<select
						id="project-filter"
						bind:value={filters.projectId}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>å…¨éƒ¨é¡¹ç›®</option>
						<!-- è¿™é‡Œåº”è¯¥åŠ¨æ€åŠ è½½é¡¹ç›®åˆ—è¡¨ -->
					</select>
				</div>

				<!-- çŠ¶æ€è¿‡æ»¤ -->
				<div>
					<label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
					<select
						id="status-filter"
						bind:value={filters.status}
						onchange={handleFilterChange}
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value={undefined}>å…¨éƒ¨çŠ¶æ€</option>
						<option value="pending">ç­‰å¾…ä¸­</option>
						<option value="queued">å·²å…¥é˜Ÿ</option>
						<option value="running">è¿è¡Œä¸­</option>
						<option value="completed">å·²å®Œæˆ</option>
						<option value="failed">å¤±è´¥</option>
						<option value="canceled">å·²å–æ¶ˆ</option>
					</select>
				</div>

				<!-- ç»Ÿè®¡ä¿¡æ¯ -->
				<div class="flex items-end">
					<div class="text-sm text-gray-600">
						å…± {pagination.total} ä¸ªä»»åŠ¡
					</div>
				</div>
			</div>
		</CardContent>
	</Card>

	<!-- ä»»åŠ¡åˆ—è¡¨ -->
	<div class="space-y-4">
		{#each tasks as task (task.id)}
			<Card class="hover:shadow-lg transition-shadow">
				<CardContent class="p-6">
					<div class="flex justify-between items-start">
						<div class="flex-1">
							<div class="flex items-center gap-3 mb-2">
								<h3 class="text-lg font-semibold text-gray-900">{task.taskName}</h3>
								<Badge class={getStatusClass(task.status)}>
									{getStatusLabel(task.status)}
								</Badge>

								<!-- è¿›åº¦æ¡ -->
								{#if task.status === 'running'}
									<div class="flex items-center gap-2 ml-auto">
										<span class="text-sm text-gray-600">{getProgressPercentage(task)}%</span>
										<div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
											<div
												class="h-full bg-blue-500 transition-all duration-300"
												style="width: {getProgressPercentage(task)}%"
											></div>
										</div>
									</div>
								{/if}
							</div>

							<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
								<!-- åŸºæœ¬ä¿¡æ¯ -->
								<div>
									<div class="text-sm text-gray-500 mb-1">ç›®æ ‡ä¿¡æ¯</div>
									<div class="text-sm">
										<div>ç›®æ ‡æ•°é‡: {task.targets.length}</div>
										<div>ç›®æ ‡ç±»å‹: {task.targetType}</div>
										<div class="truncate" title={task.targets.join(', ')}>
											ç›®æ ‡: {task.targets.slice(0, 2).join(', ')}
											{#if task.targets.length > 2}
												<span class="text-gray-500">ç­‰{task.targets.length}ä¸ª</span>
											{/if}
										</div>
									</div>
								</div>

								<!-- æ‰«æé…ç½® -->
								<div>
									<div class="text-sm text-gray-500 mb-1">æ‰«æé…ç½®</div>
									<div class="text-sm">
										<div>POCæ•°é‡: {task.config.pocIds?.length || 0}</div>
										<div>å¹¶å‘æ•°: {task.config.concurrency || 10}</div>
										<div>è¶…æ—¶: {task.config.timeout || 30}s</div>
									</div>
								</div>

								<!-- æ‰«æç»“æœ -->
								<div>
									<div class="text-sm text-gray-500 mb-1">æ‰«æç»“æœ</div>
									<div class="text-sm">
										<div>æ€»æ¼æ´: {task.resultSummary?.totalVulns || 0}</div>
										<div>
											æ‰«æè¿›åº¦: {task.resultSummary?.scannedTargets || 0}/{task.resultSummary
												?.totalTargets || 0}
										</div>
										<div class="truncate" title={getSeverityStats(task.resultSummary)}>
											{getSeverityStats(task.resultSummary)}
										</div>
									</div>
								</div>
							</div>

							<!-- æ—¶é—´ä¿¡æ¯ -->
							<div class="text-xs text-gray-500 mb-3">
								åˆ›å»ºæ—¶é—´: {formatDate(task.createdAt)}
								{#if task.startedAt}
									<span class="mx-2">|</span>
									å¼€å§‹æ—¶é—´: {formatDate(task.startedAt)}
								{/if}
								{#if task.completedAt}
									<span class="mx-2">|</span>
									å®Œæˆæ—¶é—´: {formatDate(task.completedAt)}
									<span class="mx-2">|</span>
									è€—æ—¶: {task.startedAt && task.completedAt ? formatDuration(task.startedAt, task.completedAt) : '-'}
								{:else if task.startedAt}
									<span class="mx-2">|</span>
									å·²è¿è¡Œ: {formatDuration(task.startedAt)}
								{/if}
							</div>

							<!-- é”™è¯¯ä¿¡æ¯ -->
							{#if task.error}
								<div
									class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded text-sm mb-3"
								>
									é”™è¯¯: {task.error}
								</div>
							{/if}

							<!-- æ ‡ç­¾ -->
							{#if task.tags && task.tags.length > 0}
								<div class="flex flex-wrap gap-1 mb-3">
									{#each task.tags as tag}
										<Badge variant="outline" class="text-xs">{tag}</Badge>
									{/each}
								</div>
							{/if}
						</div>

						<!-- æ“ä½œæŒ‰é’® -->
						<div class="flex flex-col gap-2 ml-4">
							<!-- æŸ¥çœ‹ç»“æœ -->
							{#if task.status === 'completed' && task.resultSummary?.totalVulns > 0}
								<Button size="sm" onclick={() => onViewResults(task)}>æŸ¥çœ‹ç»“æœ</Button>
							{/if}

							<!-- å¯åŠ¨/åœæ­¢ -->
							{#if task.status === 'pending' || task.status === 'failed'}
								<Button size="sm" variant="outline" onclick={() => startTask(task)}>å¯åŠ¨</Button>
							{:else if task.status === 'running'}
								<Button size="sm" variant="outline" onclick={() => stopTask(task)}>åœæ­¢</Button>
							{/if}

							<!-- ç¼–è¾‘ -->
							{#if task.status === 'pending' || task.status === 'failed' || task.status === 'completed'}
								<Button size="sm" variant="outline" onclick={() => onEditTask(task)}>ç¼–è¾‘</Button>
							{/if}

							<!-- åˆ é™¤ -->
							<Button size="sm" variant="destructive" onclick={() => deleteTask(task)}>åˆ é™¤</Button>
						</div>
					</div>
				</CardContent>
			</Card>
		{/each}
	</div>

	<!-- ç©ºçŠ¶æ€ -->
	{#if !isLoading && tasks.length === 0}
		<div class="text-center py-12">
			<div class="text-gray-400 text-lg mb-2">ğŸ”</div>
			<h3 class="text-lg font-medium text-gray-900 mb-1">æš‚æ— æ‰«æä»»åŠ¡</h3>
			<p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ¼æ´æ‰«æä»»åŠ¡</p>
			<Button onclick={() => onCreateTask()}>åˆ›å»ºç¬¬ä¸€ä¸ªæ‰«æä»»åŠ¡</Button>
		</div>
	{/if}

	<!-- åˆ†é¡µ -->
	{#if pagination.totalPages > 1}
		<div class="flex justify-center mt-8">
			<div class="flex items-center gap-2">
				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === 1}
					onclick={() => handlePageChange(pagination.page - 1)}
				>
					ä¸Šä¸€é¡µ
				</Button>

				<span class="px-3 py-1 text-sm text-gray-600">
					ç¬¬ {pagination.page} é¡µï¼Œå…± {pagination.totalPages} é¡µ
				</span>

				<Button
					variant="outline"
					size="sm"
					disabled={pagination.page === pagination.totalPages}
					onclick={() => handlePageChange(pagination.page + 1)}
				>
					ä¸‹ä¸€é¡µ
				</Button>
			</div>
		</div>
	{/if}

	<!-- åŠ è½½çŠ¶æ€ -->
	{#if isLoading}
		<div class="flex justify-center items-center py-12">
			<div class="text-center">
				<div
					class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
				></div>
				<p class="text-gray-500">åŠ è½½ä¸­...</p>
			</div>
		</div>
	{/if}
</div>

<!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
{#if showDeleteDialog && currentTask}
	<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
		<div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
			<h3 class="text-lg font-semibold text-gray-900 mb-2">ç¡®è®¤åˆ é™¤</h3>
			<p class="text-gray-600 mb-4">
				ç¡®å®šè¦åˆ é™¤æ‰«æä»»åŠ¡ "{currentTask.taskName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
			</p>
			<div class="flex justify-end gap-3">
				<Button variant="outline" onclick={() => (showDeleteDialog = false)}>å–æ¶ˆ</Button>
				<Button variant="destructive" onclick={confirmDelete}>ç¡®è®¤åˆ é™¤</Button>
			</div>
		</div>
	</div>
{/if}
