<script lang="ts">
	import { onMount } from 'svelte';
	import { page } from '$app/stores';
	import { goto } from '$app/navigation';
	import Button from '$lib/components/ui/button/button.svelte';
	import { Card, CardContent, CardHeader, CardTitle } from '$lib/components/ui/card';
	import Badge from '$lib/components/ui/badge/badge.svelte';
	import VulnerabilityList from '$lib/components/vulnerability/VulnerabilityList.svelte';
	import { vulnStore, selectedScanTask } from '$lib/stores/vulnerability';
	import { notifications } from '$lib/stores/notifications';
	import { TASK_STATUS_CONFIG, SEVERITY_CONFIG } from '$lib/types/vulnerability';
	import type {
		VulnScanTask,
		POCResult,
		VulnScanSummary,
		Vulnerability
	} from '$lib/types/vulnerability';

	// 页面参数
	let taskId = $derived($page.params.id);

	// 组件状态
	let isLoading = $state(true);
	let task = $state<VulnScanTask | null>(null);
	let taskResults = $state<{
		vulnerabilities: Vulnerability[];
		pocResults: POCResult[];
		summary: VulnScanSummary;
	} | null>(null);
	let taskLogs = $state<string[]>([]);
	let activeTab = $state('overview');

	// 页面加载时获取数据
	onMount(async () => {
		if (!taskId) {
			goto('/vulnerability/tasks');
			return;
		}

		try {
			isLoading = true;

			// 获取任务详情
			await vulnStore.loadScanTask(taskId);
			const selectedTask = vulnStore.getSelectedScanTask();
			if (selectedTask) {
				task = selectedTask;
			}

			// 获取任务结果
			const results = await vulnStore.loadScanResults(taskId);
			if (results && Array.isArray(results)) {
				// 如果返回的是数组，将其转换为正确的格式
				taskResults = {
					vulnerabilities: results as Vulnerability[],
					pocResults: [] as POCResult[],
					summary: {
						totalTargets: 0,
						scannedTargets: 0,
						totalVulns: results.length,
						totalVulnerabilities: results.length,
						criticalVulns: 0,
						highVulns: 0,
						highSeverityCount: 0,
						mediumVulns: 0,
						lowVulns: 0,
						infoVulns: 0,
						pocSuccessCount: 0,
						vulnTypes: {}
					} as VulnScanSummary
				};
			} else if (results && typeof results === 'object') {
				taskResults = results;
			}

			// 获取任务日志
			const logs = await vulnStore.loadScanLogs(taskId);
			if (logs) {
				taskLogs = logs;
			}
		} catch (error) {
			notifications.add({
				type: 'error',
				message: `加载任务数据失败: ${error}`
			});
		} finally {
			isLoading = false;
		}
	});

	// 格式化时间
	function formatTime(time: string | Date): string {
		return new Date(time).toLocaleString();
	}

	// 获取严重级别颜色
	function getSeverityColor(severity: string): string {
		const config = SEVERITY_CONFIG[severity as keyof typeof SEVERITY_CONFIG];
		return config ? config.color : 'gray';
	}

	// 获取任务状态颜色
	function getStatusColor(status: string): string {
		const config = TASK_STATUS_CONFIG[status as keyof typeof TASK_STATUS_CONFIG];
		return config ? config.color : 'gray';
	}

	// 导出结果
	function exportResults(format: 'json' | 'csv' | 'xml') {
		if (!taskResults) return;

		// TODO: 实现导出功能
		notifications.add({
			type: 'info',
			message: `导出${format.toUpperCase()}格式功能即将推出`
		});
	}

	// 标签页配置
	const tabs = [
		{ id: 'overview', label: '概览', icon: 'fas fa-chart-pie' },
		{ id: 'vulnerabilities', label: '漏洞列表', icon: 'fas fa-bug' },
		{ id: 'poc-results', label: 'POC结果', icon: 'fas fa-code' },
		{ id: 'logs', label: '执行日志', icon: 'fas fa-list' }
	];
</script>

<div class="container mx-auto px-4 py-6">
	<!-- 页面标题 -->
	<div class="mb-6">
		<div class="flex items-center justify-between">
			<div>
				<h1 class="text-2xl font-bold text-gray-900">漏洞扫描结果</h1>
				<p class="text-gray-600 mt-1">查看任务执行结果和详细数据</p>
			</div>
			<Button onclick={() => goto('/vulnerability/tasks')} variant="outline">返回任务列表</Button>
		</div>
	</div>

	{#if isLoading}
		<!-- 加载状态 -->
		<div class="text-center py-20">
			<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
			<p class="mt-4 text-gray-600">正在加载任务数据...</p>
		</div>
	{:else if task}
		<!-- 任务信息 -->
		<Card class="mb-6">
			<CardHeader>
				<div class="flex items-center justify-between">
					<CardTitle>任务信息</CardTitle>
					<Badge color={getStatusColor(task.status)}>{task.status}</Badge>
				</div>
			</CardHeader>
			<CardContent>
				<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
					<div>
						<p class="text-sm text-gray-600">任务名称</p>
						<p class="font-medium">{task.name}</p>
					</div>
					<div>
						<p class="text-sm text-gray-600">目标</p>
						<p class="font-medium">{task.target}</p>
					</div>
					<div>
						<p class="text-sm text-gray-600">创建时间</p>
						<p class="font-medium">{formatTime(task.createdAt)}</p>
					</div>
					<div>
						<p class="text-sm text-gray-600">完成时间</p>
						<p class="font-medium">{task.completedAt ? formatTime(task.completedAt) : '-'}</p>
					</div>
				</div>
			</CardContent>
		</Card>

		<!-- 标签页导航 -->
		<div class="mb-6">
			<div class="border-b border-gray-200">
				<nav class="-mb-px flex space-x-8">
					{#each tabs as tab}
						<button
							onclick={() => (activeTab = tab.id)}
							class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm {activeTab ===
							tab.id
								? 'border-blue-500 text-blue-600'
								: 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}"
						>
							<i class="{tab.icon} mr-2"></i>
							{tab.label}
						</button>
					{/each}
				</nav>
			</div>
		</div>

		<!-- 标签页内容 -->
		<div>
			{#if activeTab === 'overview'}
				<!-- 概览页面 -->
				{#if taskResults?.summary}
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
						<Card>
							<CardHeader>
								<CardTitle>漏洞总数</CardTitle>
							</CardHeader>
							<CardContent>
								<div class="text-3xl font-bold text-blue-600">
									{taskResults.summary.totalVulnerabilities}
								</div>
							</CardContent>
						</Card>

						<Card>
							<CardHeader>
								<CardTitle>高危漏洞</CardTitle>
							</CardHeader>
							<CardContent>
								<div class="text-3xl font-bold text-red-600">
									{taskResults.summary.highSeverityCount}
								</div>
							</CardContent>
						</Card>

						<Card>
							<CardHeader>
								<CardTitle>POC验证成功</CardTitle>
							</CardHeader>
							<CardContent>
								<div class="text-3xl font-bold text-green-600">
									{taskResults.summary.pocSuccessCount}
								</div>
							</CardContent>
						</Card>
					</div>
				{:else}
					<div class="text-center py-8 text-gray-500">暂无任务统计数据</div>
				{/if}
			{:else if activeTab === 'vulnerabilities'}
				<!-- 漏洞列表 -->
				{#if taskResults?.vulnerabilities && taskResults.vulnerabilities.length > 0}
					<VulnerabilityList vulnerabilities={taskResults.vulnerabilities} />
				{:else}
					<div class="text-center py-8 text-gray-500">暂无漏洞数据</div>
				{/if}
			{:else if activeTab === 'poc-results'}
				<!-- POC结果 -->
				{#if taskResults?.pocResults && taskResults.pocResults.length > 0}
					<div class="space-y-4">
						{#each taskResults.pocResults as result}
							<Card>
								<CardHeader>
									<div class="flex items-center justify-between">
										<CardTitle>{result.pocName}</CardTitle>
										<Badge color={result.success ? 'green' : 'red'}>
											{result.success ? '成功' : '失败'}
										</Badge>
									</div>
								</CardHeader>
								<CardContent>
									<div class="grid grid-cols-2 gap-4">
										<div>
											<p class="text-sm text-gray-600">目标URL</p>
											<p class="font-medium">{result.targetUrl}</p>
										</div>
										<div>
											<p class="text-sm text-gray-600">执行时间</p>
											<p class="font-medium">{formatTime(result.executedAt)}</p>
										</div>
									</div>
									{#if result.output}
										<div class="mt-4">
											<p class="text-sm text-gray-600 mb-2">输出结果</p>
											<pre
												class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">{result.output}</pre>
										</div>
									{/if}
								</CardContent>
							</Card>
						{/each}
					</div>
				{:else}
					<div class="text-center py-8 text-gray-500">暂无POC执行结果</div>
				{/if}
			{:else if activeTab === 'logs'}
				<!-- 执行日志 -->
				<Card>
					<CardHeader>
						<CardTitle>执行日志</CardTitle>
					</CardHeader>
					<CardContent>
						{#if taskLogs.length > 0}
							<div
								class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto"
							>
								{#each taskLogs as log}
									<div class="mb-1">{log}</div>
								{/each}
							</div>
						{:else}
							<div class="text-center py-8 text-gray-500">暂无执行日志</div>
						{/if}
					</CardContent>
				</Card>
			{/if}

			{#if task.error}
				<Card>
					<CardHeader>
						<CardTitle class="text-red-700">错误信息</CardTitle>
					</CardHeader>
					<CardContent>
						<div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded">
							{task.error}
						</div>
					</CardContent>
				</Card>
			{/if}
		</div>
	{:else}
		<div class="text-center py-20">
			<h2 class="text-2xl font-bold text-gray-900 mb-2">任务不存在</h2>
			<p class="text-gray-600 mb-4">未找到指定的扫描任务</p>
			<Button onclick={() => goto('/vulnerability/tasks')}>返回任务列表</Button>
		</div>
	{/if}
</div>
